<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>エルガマル暗号 - roki.log</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../../../../theme/style.css" rel="stylesheet" />
    <link rel="shortcut icon" href="../../../../../favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/solid.css" integrity="sha384-TbilV5Lbhlwdyc4RuIV/JhD8NR+BfMrvz4BL5QFa2we1hQu6wvREr3v6XSRfCTRp" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/brands.css" integrity="sha384-7xAnn7Zm3QC1jFjVc1A6v/toepoG3JXboQYzbM0jrPzou9OFXm/fY6Z/XiIebl/k" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/fontawesome.css" integrity="sha384-ozJwkrqb90Oa3ZNb+yKFW2lToAWYdTiF1vt8JiH5ptTGHTGcN7qdoR1F95e0kYyG" crossorigin="anonymous">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="../../../../../theme/js/css_browser_selector.js" type="text/javascript"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="roki" />
        <link href="../../../../../theme/tipuesearch/tipuesearch.css" rel="stylesheet">
        <link href="../../../../../theme/typogrify.css" rel="stylesheet">
    <link href="https://falgon.github.io/roki.log/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="roki.log Full Atom Feed" />
    <link href="https://falgon.github.io/roki.log/feeds/math.rss.xml" type="application/atom+xml" rel="alternate" title="roki.log Categories Atom Feed" />

  </head>
  <body id="index" class="archive" style="font-family: '游明朝', 'Yu Mincho' , '游明朝体' , 'YuMincho' , 'ヒラギノ明朝 Pro W3' , 'Hiragino Mincho Pro' , 'HiraMinProN-W3', 'HGS明朝E' , 'ＭＳ Ｐ明朝' , 'MS PMincho', serif;">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

<div class="modal fade" id="myModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">👋New blog information / ブログ移転のお知らせ</h4>
      </div>
      <div class="modal-body">
      This blog has been moved to <a href="https://roki.dev/roki.log">new one (roki.dev/roki.log)</a> for 
      serving you better view. This blog is no longer updated.
      Thank you for migrating and re-registering your bookmarks.
      <hr >
      このブログは, 
      <a href="https://roki.dev/roki.log">新ブログ (roki.dev/roki.log)</a> 
      に移転しました。このページの今後の更新はありませんが,
      移行用, 記録用に残されています。
      もし宜しければ, 移行, またはブックマークの再登録をよろしくお願いいたします。
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">閉じる</button>
       </div>
    </div>
  </div>
</div>

    <nav class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../../../..">roki.log</a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
                    <a href="../../../../../pages/about"><i class="fas fa-info-circle" style="margin-right: 4px;"></i>About</a>
            </li>
            <li>
            </li>
            
            <li><a href="../../../../../tags.html"><i class="fas fa-tags" style="margin-right: 4px;"></i>Tags</a></li>
            <li><span>
                <form class="navbar-search" action="https://falgon.github.io/roki.log/search.html">
                    <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
            </li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
    <section id="content" class="article content">
      <header>
        <h2 class="entry-title">
          エルガマル暗号
        </h2>
        
        <div class="text-muted">金 13 7月 2018</div>
      </header>
<!-- .entry-content -->
      <div class="entry-content">
        <p>エルガマル暗号が離散対数問題の応用であることは認知していたものの, 
きっちりと自分でまとめたことが無かったと思うので, 
それに関連する諸々の前提についてもふまえて, 一度書くことにした. 
また, その処理系を<a href="#impl">実装した</a>.
本エントリでは, 同暗号プロトコルの話の前にまず前提を示し, 
その後,&nbsp;実装するという観点から見た要点を示す.</p>
<p><i>※ 内容にはできる限り注意を払っておりますが, 筆者は暗号プロトコル等に関する専門家ではないため, 注意してください. 間違った箇所, 不自然な箇所等があれば,&nbsp;ご報告いただけると幸いです.</i></p>
<h3>ユークリッドの互除法</h3>
<p>これは, とても有名なアルゴリズムだと思われるので, 
わざわざ特別取り上げる必要はないようにも思ったのだが,
本エントリでは最大公約数を存分に利用するので, これを自明として取り上げないのも頂けない. 
したがって, 簡単に説明, 証明をして終わりとする.&nbsp;ユークリッドの互除法は,</p>
<div class="panel panel-default">
  <div class="panel-heading def"><a name="euclidean" class="disabled">ユークリッドの互除法</a></div>
  <div class="panel-body" style="overflow:scroll">
&#92;(2&#92;) つの自然数 &#92;(a, b\in\mathbb{N}&#92;) の最大公約数を求めるアルゴリズム.
  </div>
</div>

<p>である. 最大公約数を求める方法として, 素因数分解をひたすら行うのには, 計算量的に限界がある.
そこで, 古代ギリシャの数学者ユークリッドは, 
この問題を幾何学的に考察した(図示された例は調べるとたくさんある).
たとえば <span class="math">\(a=12345678,\ b=87654321\)</span>
の最大公約数を求めるとする(以下これを <span class="math">\(\gcd(a,b)=c\)</span> と書く).&nbsp;これをユークリッドの互除法は,
</p>
<div class="math">\begin{array}{rr}
87654321&amp;=&amp;12345678\cdot 7&amp;+&amp;1234575\\\
12345678&amp;=&amp;1234575\cdot 9&amp;+&amp;1234503\\\
1234575&amp;=&amp;1234503&amp;+&amp;72\\\
1234503&amp;=&amp;72\cdot 17145&amp;+&amp;63\\\
72&amp;=&amp;63&amp;+&amp;9\\\
63&amp;=&amp;\underbrace{9}_{c}\cdot 7
\end{array}</div>
<p>より \(\gcd(a,b)=9\) というように解く.&nbsp;これで最大公約数を求まる根拠を以下証明する.</p>
<div class="panel panel-default">
  <div class="panel-heading lemma"><a class="disabled" id="lemma1">補題 1</a></div>
  <div class="panel-body" style="overflow:scroll">
&#92;(\gcd(a,b)=\gcd(a-b, b)=\gcd(a-2b,b)=\gcd(a-3b,b)=\cdots\ (a, b\in\mathbb{N})&#92;) が成り立つ.
</div>
</div>

<p><strong>証明</strong>: <span class="math">\(a,\ b\)</span> の公約数を <span class="math">\(d\)</span> とすると, 
<span class="math">\(d\mid a\land d\mid b \Rightarrow d\mid a-b\)</span>.
また <span class="math">\(a-b\)</span> と <span class="math">\(b\)</span> の公約数を <span class="math">\(e\)</span> とすると, <span class="math">\(e\mid a-b\land e\mid b\Rightarrow e\mid (a-b)+b=e\mid a\)</span>.</p>
<p>\(\therefore\) 公約数の全体が一致するから, 最大公約数も一致して, 
<span class="math">\(\gcd(a,b)=\gcd(a-b,b)\)</span>. これを繰り返すと \[
\gcd(a,b)=\gcd(a-b,b)=\gcd(a-2b,b)=\gcd(a-3b,b)=\cdots
\]&nbsp;\(\square\)</p>
<div class="panel panel-default">
  <div class="panel-heading prop"><a class="disabled" id="prop1">命題 1</a></div>
  <div class="panel-body" style="overflow:scroll">
  ユークリッドの互除法により &#92;(c&#92;) が最大公約数となる.
  </div>
  </div>

<p><strong>証明</strong>: \(a, b\in\mathbb{Z}^{+}\) があるとき, 除算は
\(a=bq+r,\ 0\leq r\lt b\) と表せる.
<a href="#lemma1">補題 1</a> より, <span class="math">\(\gcd(a,b)=\gcd(a-bq,b)=\gcd(b,r)\)</span> がいえる.&nbsp;ここで, 
</p>
<div class="math">\begin{array}{ll}
a&amp;=&amp;bq_1+r_1&amp; (0\lt r_1\lt b),&amp; \gcd(a,b)&amp;=&amp;\gcd(b,r_1)\\\
b&amp;=&amp;r_1q_2+r_2&amp; (0\lt r_2\lt r_1),&amp; \gcd(b,r_1)&amp;=&amp;\gcd(r_1,r_2)\\\
r_1&amp;=&amp;r_2q_3+r_3&amp; (0\lt r_3\lt r_2),&amp; \gcd(r_1,r_2)&amp;=&amp;\gcd(r_2,r_3)\\\
\cdots &amp;&amp;&amp; \cdots &amp;&amp;&amp; \cdots \\\
r_i&amp;=&amp;r_{i+1}q_{i+2}+r_{i+2}&amp; (0\lt r_{i+2}\lt r_{i+1}),&amp; \gcd(r_i,r_{i+1})&amp;=&amp;\gcd(r_{i+1},r_{i+2})\\\
\cdots &amp;&amp;&amp; \cdots &amp;&amp;&amp; \cdots \\\
r_{n-2}&amp;=&amp;r_{n-1}q_n+r_n&amp;(0\lt r_n\lt r_{n-1}),&amp;\gcd(r_{n-2},r_{n-1})&amp;=&amp;\gcd(r_{n-1},r_n)\\\
r_{n-1}&amp;=&amp;r_nq_{n+1}&amp;&amp; \gcd(r_{n-1},r_n)&amp;=&amp;r_n
\end{array}</div>
<p>
として, <span class="math">\((n+1)\)</span> 回で割り切れたとすると, <span class="math">\(r_n\)</span> が最大公約数 <span class="math">\(c\)</span> となる.&nbsp;\(\square\)</p>
<h3>ガロア体</h3>
<p>ある集合に対して, 加法および乗法における結合律の満足と分配律の成立が両立する演算を定義する. この公理を体の公理といい,
それを満たす集合を体, とくに位数が有限である体を有限体, ガロア体といい, これを素数 <span class="math">\(p\)</span> を位数として <span class="math">\(GF(p)\)</span>&nbsp;と書く. </p>
<p>このような体は位数を素数で構成すると簡単に構成でき<sup id="fnref-1"><a class="footnote-ref" href="#fn-1">1</a></sup>, これを素体という. いま, <span class="math">\(k\in\mathbb{Z}\)</span> と合同な整数の全体を <span class="math">\(\overline{k}\)</span> と表し, これを <span class="math">\(k\)</span> を含む剰余類という.  なお, 一般に <span class="math">\(a\equiv b\pmod{c} \Leftrightarrow \overline{a}=\overline{b}\)</span> である.
ガロア体は, \(\mathbb{Z}/p\mathbb{Z}\)(以下これを簡単のため, \(\mathbb{Z}_p\) と書く.) を整数を <span class="math">\(p\)</span> で割った余りから構成される素体として, 次のように構成することで, その同型となる.
\[\mathbb{Z}_p=\left\{\overline{0},\cdots, \overline{p-1} \pmod{p}&nbsp;\right\}\]</p>
<p>例えば, <span class="math">\(GF(2) = \{0, 1\}\)</span> であり, このときの四則演算は「整数の世界で四則演算をして, それを <span class="math">\(2\)</span> で割った余り」と定義する<sup id="fnref-2"><a class="footnote-ref" href="#fn-2">2</a></sup>.
なおこの演算規則は加算が <span class="caps">XOR</span> に, 乗算が <span class="caps">AND</span>&nbsp;に対応する.</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="kt">:</span><span class="n">m</span> <span class="o">+</span><span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="kr">let</span> <span class="n">finitef</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">Int</span><span class="p">];</span> <span class="n">finitef</span> <span class="n">p</span> <span class="ow">=</span> <span class="p">[</span><span class="n">x</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="n">p</span> <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="n">finitef</span> <span class="mi">2</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="n">map</span> <span class="p">(`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="n">finitef</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">map</span> <span class="p">(`</span><span class="n">xor</span><span class="p">`</span> <span class="mi">0</span><span class="p">)</span> <span class="o">$</span> <span class="n">finitef</span> <span class="mi">2</span><span class="p">)</span>
<span class="kt">True</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="n">map</span> <span class="p">((`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">2</span><span class="p">)</span> <span class="o">.</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">(</span><span class="n">finitef</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">map</span> <span class="p">(`</span><span class="n">xor</span><span class="p">`</span> <span class="mi">1</span><span class="p">)</span> <span class="o">$</span> <span class="n">finitef</span> <span class="mi">2</span><span class="p">)</span>
<span class="kt">True</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="n">map</span> <span class="p">((`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">2</span><span class="p">)</span> <span class="o">.</span> <span class="p">(</span><span class="o">*</span><span class="mi">0</span><span class="p">))</span> <span class="p">(</span><span class="n">finitef</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">map</span> <span class="p">(</span><span class="o">.&amp;.</span> <span class="mi">0</span><span class="p">)</span> <span class="o">$</span> <span class="n">finitef</span> <span class="mi">2</span><span class="p">)</span>
<span class="kt">True</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="n">map</span> <span class="p">(`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="n">finitef</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">map</span> <span class="p">(</span><span class="o">.&amp;.</span> <span class="mi">1</span><span class="p">)</span> <span class="o">$</span> <span class="n">finitef</span> <span class="mi">2</span><span class="p">)</span>
<span class="kt">True</span>
</pre></div>


<h3>オイラーの <span class="math">\(\phi\)</span>&nbsp;関数</h3>
<p>オイラーの <span class="math">\(\phi\)</span> (トーシェント)関数は, 正整数 <span class="math">\(n\)</span> に対する <span class="math">\(1\)</span> から <span class="math">\(n\)</span> までの自然数のうち
<span class="math">\(n\)</span> と互いに素なものの個数を <span class="math">\(\phi(n)\)</span> として与えることによって定まる乗法的関数<sup id="fnref-3"><a class="footnote-ref" href="#fn-3">3</a></sup>である. 
この関数は \(p_i\) を <span class="math">\(n\)</span> の素因数として, 次の式で定義できる<sup id="fnref-4"><a class="footnote-ref" href="#fn-4">4</a></sup>.</p>
<div class="panel panel-default">
  <div class="panel-heading def"><a name="totientf" class="disabled">オイラーの &#92;(\phi&#92;) 関数</a></div>
  <div class="panel-body" style="overflow:scroll">
&#92;[\phi(n)=n\displaystyle\prod_{i=1}^k(1-\dfrac{1}{p_i})&#92;]
  </div>
</div>

<p>例えば <span class="math">\(\phi(14) = 6\)</span> である(<span class="math">\(14 = 2 \cdot 7\)</span> だから, <span class="math">\(14\left(1-\dfrac{1}{2}\right)\left(1-\dfrac{1}{7}\right) = 6\)</span>. これを列挙すると, <span class="math">\(1,3,5,9,11,13\)</span>). 
特に, <span class="math">\(n\)</span> が素数である場合, <span class="math">\(1\)</span> から <span class="math">\(n-1\)</span> のうち <span class="math">\(n\)</span> の素因数である 
<span class="math">\(n\)</span> を因数としてもつことはないから <span class="math">\(\phi(n) = n - 1\ \left(n\ is\ prime\right)\)</span>&nbsp;が成り立つ.</p>
<p>以下で, 先頭から <span class="math">\(100\)</span> 個の素数 
\(p_i=p_0,p_1,p_2,\cdots,p_{99}\ \left(p\ is\ prime\right)\)
に対して, \(\phi(p_i)=p_i - 1\)&nbsp;であることを確認する. </p>
<div class="highlight"><pre><span></span><span class="cm">{-# OPTIONS_GHC -Wall #-}</span>
<span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Data.Numbers.Primes</span> <span class="p">(</span><span class="nf">primes</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.List</span> <span class="p">(</span><span class="nf">nub</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Tuple.Extra</span> <span class="p">(</span><span class="nf">first</span><span class="p">,</span> <span class="nf">second</span><span class="p">,</span> <span class="nf">dupe</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Ratio</span> <span class="p">((</span><span class="o">%</span><span class="p">),</span> <span class="nf">numerator</span><span class="p">)</span>

<span class="nf">primeFactors</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span>
<span class="nf">primeFactors</span> <span class="ow">=</span> <span class="n">flip</span> <span class="n">go</span> <span class="n">primes</span>
    <span class="kr">where</span>
        <span class="n">go</span> <span class="kr">_</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="kt">[]</span>
        <span class="n">go</span> <span class="n">n</span> <span class="n">xxs</span><span class="o">@</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> 
            <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="p">(</span><span class="mi">2</span> <span class="ow">::</span> <span class="kt">Int</span><span class="p">))</span> <span class="ow">=</span> <span class="p">[</span><span class="n">n</span> <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="kr">let</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span> <span class="n">n</span> <span class="p">`</span><span class="n">quotRem</span><span class="p">`</span> <span class="n">x</span> <span class="kr">in</span>
                <span class="kr">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span> <span class="n">x</span><span class="kt">:</span><span class="n">go</span> <span class="n">d</span> <span class="n">xxs</span> <span class="kr">else</span> <span class="n">go</span> <span class="n">n</span> <span class="n">xs</span>

<span class="nf">totient</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span>
<span class="nf">totient</span> <span class="ow">=</span> <span class="n">numerator</span> <span class="o">.</span> <span class="n">uncurry</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">.</span> <span class="n">first</span> <span class="p">(</span><span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">.</span> <span class="n">second</span> <span class="p">(</span><span class="n">foldr</span> <span class="p">(</span><span class="nf">\</span><span class="n">x</span> <span class="n">acc</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">acc</span><span class="p">)</span> <span class="mi">1</span> <span class="o">.</span> <span class="n">nub</span> <span class="o">.</span> <span class="n">primeFactors</span><span class="p">)</span> <span class="o">.</span> <span class="n">dupe</span>

<span class="nf">main</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">main</span> <span class="ow">=</span> <span class="n">print</span> <span class="o">$</span> <span class="n">and</span> <span class="o">$</span> <span class="n">take</span> <span class="mi">100</span> <span class="p">[</span><span class="n">totient</span> <span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span> <span class="ow">&lt;-</span> <span class="n">primes</span><span class="p">]</span>
</pre></div>


<h3>フェルマーの小定理</h3>
<div class="panel panel-default">
  <div class="panel-heading lemma"><a class="disabled" id="lemma2">補題 2</a></div>
  <div class="panel-body" style="overflow:scroll">
奇素位数 $p$ のガロア体 &#92;(<span class="caps">GF</span>(p)&#92;) の既約剰余類郡を 
&#92;(\mathbb{Z}^{\ast}\_{p}=\left&#92;{\overline{1},\overline{2},\cdots,\overline{p-1}\right&#92;}&#92;) としたとき, 
&#92;(^\exists b,^\exists c \in \mathbb{Z}^{\ast}\_{p} \left(b \neq c\right)&#92;) があって,
&#92;(ba\equiv ca\pmod{p}&#92;) となる &#92;(a \in \mathbb{Z}^{\ast}\_{p}\ \left(\gcd(a, p)=1\right)&#92;) は存在せず, 
&#92;(\mathbb{Z}^{\ast}\_{p}&#92;) の異なる項は非合同.
</div>
</div>

<p><strong>証明</strong>: <span class="math">\(\gcd(a, p) = 1\)</span> であるから <span class="math">\(ba\equiv ca\pmod{p}\)</span> の両辺から <span class="math">\(a\)</span> を約せて <span class="math">\(b\equiv c\pmod{p}\)</span>. 
<span class="math">\(b &lt; p\)</span> および <span class="math">\(c &lt; p\)</span> から従い <span class="math">\(b = c\)</span> となり不条理.&nbsp;\(\square\)</p>
<div class="panel panel-default">
  <div class="panel-heading theo"><a name="fermatstheorem" class="disabled">フェルマーの小定理</a></div>
  <div class="panel-body" style="overflow:scroll">&#92;(p&#92;) が素数 &#92;(\Rightarrow\ ^\forall a\ \left(\gcd(a,p) = 1\right)&#92;) に対して, &#92;[a^{p-1}\equiv 1\pmod{p}\label{eq:second}\tag{2}&#92;]
  </div>
</div>

<p><strong>証明</strong>: <a href="#lemma1">補題 2</a> より従って, \(\mathbb{Z}^{\ast}_{p}\) の各要素と <span class="math">\(a\)</span> の積は全て異なり, かつ \(\mathbb{Z}^{\ast}_{p}\) はそれらで尽くされる. 
また, それらの積の <span class="math">\(\pmod{p}\)</span> は <span class="math">\(\pmod{p}\)</span> の既約代表系 \(\{1, 2, \cdots, p-1\}\)&nbsp;のすべての積と合同:
</p>
<div class="math">$$1\cdot 2\cdot\cdots\cdot(p-1)\equiv (a)(2a)\cdots(p-1)a\pmod{p}$$</div>
<div class="math">$$(p-1)!\equiv (p-1)!\cdot a^{p-1}\pmod{p}$$</div>
<p>
<span class="math">\(\gcd((p-1)!, p) = 1\)</span> であるから,&nbsp;両辺からこれを約し, </p>
<p>\[a^{p-1}\equiv 1\pmod{p} \]&nbsp;\(\square\)</p>
<p>簡単に確認<sup id="fnref-5"><a class="footnote-ref" href="#fn-5">5</a></sup>.</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="kt">:</span><span class="n">m</span> <span class="o">+</span><span class="kt">Data</span><span class="o">.</span><span class="kt">Numbers</span><span class="o">.</span><span class="kt">Primes</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Numbers</span><span class="o">.</span><span class="kt">Primes</span><span class="o">&gt;</span> <span class="kr">let</span> <span class="n">fermatLT</span> <span class="ow">::</span> <span class="kt">Integer</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">Integer</span><span class="p">];</span> <span class="n">fermatLT</span> <span class="n">p</span> <span class="ow">=</span> <span class="p">[</span><span class="n">a</span><span class="o">^</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="n">p</span> <span class="o">|</span> <span class="n">a</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gcd</span> <span class="n">p</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Numbers</span><span class="o">.</span><span class="kt">Primes</span><span class="o">&gt;</span> <span class="n">and</span> <span class="o">$</span> <span class="n">map</span> <span class="p">((</span><span class="n">all</span> <span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="p">))</span> <span class="o">.</span> <span class="n">fermatLT</span><span class="p">)</span> <span class="o">$</span> <span class="n">take</span> <span class="mi">50</span> <span class="n">primes</span>
<span class="kt">True</span>
</pre></div>


<h3>原始元</h3>
<p><div class="panel panel-default">
  <div class="panel-heading def"><a class="disabled">位数</a></div>
  <div class="panel-body" style="overflow:scroll">
\(n \in\mathbb{Z}^{+},\ a \in\mathbb{Z},\ \gcd(n, a) = 1\) に対して \(a^d\equiv 1\pmod{n}\) のような最小の \(d\in\mathbb{Z}^{+}\) を \(a\) の\(\pmod{n}\) での位数<sup id="fnref-6"><a class="footnote-ref" href="#fn-6">6</a></sup>といい, これを \(d=\DeclareMathOperator*{\ord}{ord}\ord_n(a)\) と書く. 
  </div>
</div></p>
<p>ただし, 以下添え字 <span class="math">\(n\)</span> は明確である場合には省くこととする. 
たとえば <span class="math">\(p=7\)</span> としたときの <span class="math">\(1 \leq a\leq 6\)</span> の <span class="math">\(a\)</span> の冪<span class="math">\(\pmod 7\)</span>&nbsp;を一覧にすると次のとおりである.</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="kr">let</span> <span class="n">f</span> <span class="n">p</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="p">(</span><span class="nf">\</span><span class="n">x</span> <span class="n">acc</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="o">^</span><span class="n">x</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="n">p</span> <span class="o">|</span> <span class="n">a</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="kt">:</span> <span class="n">acc</span><span class="p">)</span> <span class="kt">[]</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="n">p</span><span class="p">]</span>
<span class="kt">Prelude</span><span class="o">&gt;</span> <span class="n">mapM_</span> <span class="n">print</span> <span class="o">$</span> <span class="n">f</span> <span class="mi">7</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
</pre></div>


<p>6 乗ですべて <span class="math">\(\equiv 1\pmod{7}\)</span> というのが, 先に述べたフェルマーの小定理 <span class="math">\(\eqref{eq:second}\)</span> であるが,
それよりも前に <span class="math">\(\equiv 1\pmod{7}\)</span> となる数があることがわかる.
これをいま述べた \(\DeclareMathOperator*{\ord}{ord}\ord\) で表せば, 
\(\DeclareMathOperator*{\ord}{ord} \ord(1)=1, \ord(2)=3, \ord(3)=6, \ord(4)=3, \ord(5)=6, \ord(6)=2\) である. 
また, この結果が <span class="math">\(\phi(6) = 2\)</span> と整合であることが確認できる. \(\DeclareMathOperator*{\ord}{ord}\ord(3), \ord(5)\) が他と相違なる部分は, <span class="math">\(1\)</span> から <span class="math">\(6\)</span> までの数がちょうど <span class="math">\(1\)</span> 回ずつ現れることである.&nbsp;このように,</p>
<div class="panel panel-default">
  <div class="panel-heading def"><a name="primitive_root" class="disabled">原始根</a></div>
  <div class="panel-body" style="overflow:scroll">
&#92;(\pmod{n}&#92;) での位数が &#92;(\phi(n)&#92;) である整数
  </div>
</div>

<p>を <span class="math">\(n\)</span>&nbsp;の原始根という.</p>
<p>同様に, 原始元とは, 奇素数 <span class="math">\(p\)</span> と元 <span class="math">\(a \in \mathbb{Z}^{+} \left(a &lt; p\right)\)</span> があって,
<span class="math">\(p\)</span> を法とする剰余類で累乗していくと, <span class="math">\(1\)</span> から <span class="math">\(p-1\)</span> のすべての元をつくす郡(巡回郡)を構成する元 <span class="math">\(a\)</span> をいう.&nbsp;これは, </p>
<ul>
<li><span class="math">\(a^{p-1}\)</span> で初めて <span class="math">\(a^{n} \equiv 1\pmod{p}\)</span> となるような元 <span class="math">\(a\)</span>(生成元であるから)</li>
<li>位数が<span class="math">\(p-1\)</span> となる元 <span class="math">\(a\)</span></li>
</ul>
<p>ともいえる. </p>
<p>とくになにも考えず, 与えられた素数 <span class="math">\(p\)</span> に対する <span class="math">\(GF(p)\)</span>&nbsp;の原始元を素朴に生成してみる.</p>
<div class="highlight"><pre><span></span><span class="cm">{-# OPTIONS_GHC -Wall #-}</span>
<span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Data.List</span> <span class="p">(</span><span class="nf">findIndices</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Numbers.Primes</span> <span class="p">(</span><span class="nf">primes</span><span class="p">)</span>

<span class="nf">primitiveElem</span> <span class="ow">::</span> <span class="kt">Integer</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">Integer</span><span class="p">]</span>
<span class="nf">primitiveElem</span> <span class="n">p</span> <span class="ow">=</span> <span class="n">go</span> <span class="p">[((</span><span class="n">a</span><span class="o">^</span><span class="n">n</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">2</span><span class="o">..</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="kr">where</span>
        <span class="n">go</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="kt">[]</span><span class="p">;</span>
        <span class="n">go</span> <span class="n">xs</span><span class="o">@</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="kr">_</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">let</span> <span class="n">d</span> <span class="ow">=</span> <span class="n">drop</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="n">xs</span> <span class="kr">in</span> 
            <span class="kr">case</span> <span class="n">findIndices</span> <span class="n">fst</span> <span class="o">$</span> <span class="n">take</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="n">xs</span> <span class="kr">of</span> 
               <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">i</span> <span class="o">==</span> <span class="n">fromIntegral</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">snd</span> <span class="n">x</span><span class="kt">:</span><span class="n">go</span> <span class="n">d</span>
                <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">go</span> <span class="n">d</span>

<span class="nf">main</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">main</span> <span class="ow">=</span> <span class="n">mapM_</span> <span class="p">(</span><span class="n">print</span> <span class="o">.</span> <span class="n">primitiveElem</span><span class="p">)</span> <span class="o">$</span> <span class="n">take</span> <span class="mi">100</span> <span class="o">$</span> <span class="n">drop</span> <span class="mi">1</span> <span class="n">primes</span>
</pre></div>


<p><a href="https://wandbox.org/permlink/1ESn07fY95vwqEpv" name="thiscode">実行結果</a><sup id="fnref-7"><a class="footnote-ref" href="#fn-7">7</a></sup>. 
上の冪の一覧のとおり, 素数 <span class="math">\(p\)</span> を位数とするガロア体はその原始元を <span class="math">\(a\)</span>&nbsp;として
</p>
<div class="math">$$GF(p)= \left\{0, 1, a, a^{2}, \cdots, a^{p-2}\label{eq:third}\tag{3}\right\}$$</div>
<p> と構成されることがわかる.
<span class="math">\(p=7\)</span> であれば, 原始根は <span class="math">\(\phi(6)=2\)</span> であり, その <span class="math">\(1\)</span> つは <span class="math">\(g=3\)</span> であるからこの冪乗 <span class="math">\(n\equiv g^{f}\pmod{7}\)</span> で <span class="math">\(p-1=6\)</span> までの全て, 
すなわち先の \(\DeclareMathOperator*{\ord}{ord}\ord(3)\)&nbsp;の縦の列が得られる.</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="p">[</span><span class="mi">3</span><span class="o">^</span><span class="n">x</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">7</span> <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="mi">6</span><span class="p">]]</span>
<span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</pre></div>


<h3>離散対数問題</h3>
<p><span class="math">\(\eqref{eq:third}\)</span> を前提とし <span class="math">\(g^{f}\equiv n\pmod{p}\ \left(1\leq n \leq p-1\right)\)</span> を満たす
<span class="math">\(f\)</span> は <span class="math">\(0\leq f\leq p-2\)</span> のうち, ただ <span class="math">\(1\)</span> つだけ存在する. これを <span class="math">\(n\)</span> の指数または離散対数といい, 
\(f=\log_{g}n\pmod{p}\) および \(\DeclareMathOperator*{\Ind}{Ind}f=\Ind_{g}(n)\) と書く. 
この <span class="math">\(n\)</span> を真数, または離散真数という. 
以下は, \(3\leq p \leq 19\ \left(p\ is\ prime\right)\) でその最小の原始根 <span class="math">\(g\)</span> の冪乗
\(n\equiv g^f\pmod{p}\) の昇順を <span class="math">\(x\)</span> 軸, 
\(\DeclareMathOperator*{\Ind}{Ind}f=\Ind_{g}(n)\) を <span class="math">\(y\)</span> 軸として,
それぞれの各離散対数をプロットした図<sup id="fnref-8"><a class="footnote-ref" href="#fn-8">8</a></sup>である.</p>
<p><img alt="離散対数を視覚化した図" src="../../../../../images/2018/June/fig.png"></p>
<p>これを見てもわかるように, <span class="math">\(f\)</span> の値に規則性は見られず, 予測困難な振る舞いをすることがわかる.
例えば, <span class="math">\(p=19,\ g=2,\ n=3\)</span>&nbsp;とすると</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="n">head</span> <span class="p">[</span><span class="n">f</span> <span class="o">|</span> <span class="n">f</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">17</span><span class="p">],</span> <span class="mi">2</span><span class="o">^</span><span class="n">f</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">19</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mi">19</span><span class="p">]</span>
<span class="mi">13</span>
</pre></div>


<p>より <span class="math">\(f=13\)</span> であることがわかる. この場合, まだ <span class="math">\(p\)</span> が小さい素数であるからこそ, 
このような総当たりで解が得られるのだが,
大きな <span class="math">\(p\)</span> に対する総当たりでは, 実用的な時間で解を得ることができない.
これを離散対数問題という.
エルガマル暗号は, <span class="math">\(g\)</span> と <span class="math">\(f\)</span> から <span class="math">\(n\)</span> を求めることは容易であるが,
いま述べたように <span class="math">\(g\)</span> と <span class="math">\(n\)</span> から <span class="math">\(f\)</span> を求めることは困難であるという事実を利用することで,
公開鍵暗号方式としての成立および暗号学的安全性の担保を確立する<sup id="fnref-9"><a class="footnote-ref" href="#fn-9">9</a></sup>.</p>
<h3><a name="genencanddec" class="disabled">暗号の生成と解読</a></h3>

<p>以上を前提として, 暗号の生成とその解読方法について示す.&nbsp;受信者は下準備として次の手順で公開鍵と秘密鍵を生成する:</p>
<ol>
<li>大きな素数 <span class="math">\(p\)</span>&nbsp;を選ぶ.</li>
<li><span class="math">\(\phi(p-1)\)</span> 個の <span class="math">\(p\)</span> の原始根のうち, 任意の <span class="math">\(1\)</span> つ <span class="math">\(g\)</span>&nbsp;を選ぶ.</li>
<li>任意の正整数 \(a\in\mathbb{Z}^{+},\ \left(a &lt; p\right)\)&nbsp;を選ぶ.</li>
<li><span class="math">\(y\equiv g^a\pmod{p}\)</span>&nbsp;を計算する.</li>
<li>公開鍵を \(\left\{p, g, y\right\}\), 秘密鍵を \(\left\{a\right\}\)&nbsp;とする.</li>
</ol>
<p>平文の列を \(x_1,x_2,\cdots,x_t\ \left(x_i &lt; p\right)\), 最初の平文を <span class="math">\(x\)</span> とし,&nbsp;発信者は次の手順で暗号文を生成する:</p>
<ol>
<li>任意の正整数 \(k\in\mathbb{Z}^{+}\)&nbsp;を選ぶ.</li>
<li>\(\alpha\equiv g^k\pmod{p}\)&nbsp;を計算する.</li>
<li>\(z\equiv y^k\pmod{p}\) と \(\beta\equiv xz\pmod{p}\) を計算し, <span class="math">\(x\)</span> に対する \(\gamma =\left\{\alpha,\ \beta\right\}\)&nbsp;を得る.</li>
<li>\(x_t\) に到達するまで 1 から 3 の手順を繰り返す. 到達すれば,&nbsp;暗号文の生成は完了である.</li>
</ol>
<p>受信者は次の手順で暗号を解く:</p>
<ol>
<li><span class="math">\(\gamma\)</span> から <span class="math">\(x\)</span> を得るためには, <span class="math">\(y^k\)</span> を要する. 秘密鍵 <span class="math">\(a\)</span> を使い, <span class="math">\(z\equiv y^k \equiv \left(g^a\right)^k\equiv\left(g^k\right)^a\equiv\alpha^a\pmod{p}\)</span>&nbsp;と計算する.</li>
<li><span class="math">\(x\equiv \dfrac{\beta}{z}\pmod{p}\)</span> であるので, <span class="math">\(\pmod{p}\)</span> で <span class="math">\(z\)</span> のモジュラ逆数 <span class="math">\(zq\equiv 1\pmod{p},\ q\equiv\dfrac{1}{z}\pmod{p}\)</span>&nbsp;を計算する.</li>
<li>\(x\equiv\dfrac{\beta}{z}\equiv\beta q\equiv u\pmod{p}\ \left(u&lt; p\right)\) を計算する. ここで, <span class="math">\(x&lt; p\)</span> であるから,&nbsp;この結果が平文である.</li>
</ol>
<p>実際にこれを手計算で実行してみる.
<span class="math">\(p=97\)</span> とする. 従って <span class="math">\(g=5\)</span> となる. ここで <span class="math">\(a=7\)</span> とする.
<span class="math">\(y\equiv 5^7\pmod{97}\)</span> より <span class="math">\(y\equiv 5^7\equiv 40\pmod{97}\)</span> だから, 公開鍵は \(\left\{97,5,40\right\}\),
秘密鍵は \(\left\{7\right\}\) である. 次に暗号文を作成する.
平文は,&nbsp;次のアスキーコードで表現された文字列とする.</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="kt">:</span><span class="n">m</span> <span class="o">+</span><span class="kt">Data</span><span class="o">.</span><span class="kt">Char</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Char</span><span class="o">&gt;</span> <span class="n">map</span> <span class="n">ord</span> <span class="s">&quot;OK&quot;</span>
<span class="p">[</span><span class="mi">79</span><span class="p">,</span><span class="mi">95</span><span class="p">]</span>
</pre></div>


<p>ここで <span class="math">\(x=79,\ k = 5\)</span> とする. 
<span class="math">\(\alpha\equiv 5^5\equiv 21\pmod{97}\)</span> また
<span class="math">\(z\equiv 40^5\equiv 10\pmod{97}\)</span> より <span class="math">\(\beta\equiv 79\cdot 10\equiv 14\pmod{97}\)</span>.
従って, \(\gamma=\left\{21, 14\right\}\) となる. 
<span class="math">\(x=95\)</span> にも同様の計算(<span class="math">\(k\)</span> は毎度ランダムに選ぶ. 次は <span class="math">\(k=6\)</span> であったとした.)を施して, 
全体の暗号文を<code>[21, 14, 8, 73]</code>とする. これを解読する.
<span class="math">\(z\equiv 21^7\equiv 10\pmod{97}\)</span> で, <span class="math">\(z\equiv y^k\pmod{97}\)</span>.
<span class="math">\(10q\equiv 1\pmod{97}\)</span> だから <span class="math">\(q\equiv\dfrac{1}{10}\equiv 68\pmod{97}\)</span>.
ここで <span class="math">\(u\equiv 14\cdot 68\equiv 97\pmod{p}\)</span> で, <span class="math">\(u&lt; p\)</span> だから <span class="math">\(x\equiv u\pmod{p}\)</span>.
よって <span class="math">\(1\)</span> 文字目は <span class="math">\(79\)</span>. 同様に <span class="math">\(2\)</span> 文字目も計算し, 全体の平文が手に入る.
解読の段階で <span class="math">\(a=7\)</span> を知らなかった場合, 離散対数問題を解くことに相当するため,&nbsp;平文を得るのは非常に困難となる.</p>
<h3>実装</h3>
<p>ここからは, これをプログラムとして実装することを考える.
第一に必要となるものは, 大きな素数の生成器である.
方法としては, ランダムに奇数を生成し, Miller-Rabin 素数判定法などの確率的素数判定法を用いることが実例として多い<sup id="fnref-10"><a class="footnote-ref" href="#fn-10">10</a></sup>ので, ひとまず素数生成には Miller-Rabin&nbsp;素数判定法を使うこととする. </p>
<h4>フェルマーテスト, Miller-Rabin&nbsp;素数判定法</h4>
<p>Miller-Rabin 素数判定法は, フェルマーテストの改良と言えるので, まずその説明から行う.
フェルマーテストは, 先に述べたフェルマーの小定理 <span class="math">\(\eqref{eq:second}\)</span> の対偶<sup id="fnref-11"><a class="footnote-ref" href="#fn-11">11</a></sup>を利用した判定方法であるといえる.</p>
<div class="panel panel-default">
  <div class="panel-heading def"><a class="disabled" name="fermattest">フェルマーテスト</a></div>
  <div class="panel-body" style="overflow:scroll">
&#92;(FT_n(a): =\gcd(a, n)=1&#92;) を満たす &#92;(n \in\mathbb{Z}^{+}&#92;) と底 &#92;(a\in\mathbb{Z}^{+}&#92;) があって, &#92;(a^{n-1}\equiv 1\pmod{n}&#92;) が成り立つか.
  </div>
</div>

<p>この答えが yes であるとき <span class="math">\(n\)</span> は \(FT_n(a)\) をパスしたといえば, 
フェルマーの小定理は, 「<span class="math">\(n\)</span> が素数ならば, <span class="math">\(n\)</span> は <span class="math">\(^\forall a\left(\gcd(a,n)=1\right)\)</span> に対する \(FT_n(a)\) をパスした」といい, この対偶をとると,「\(FT_n(a)\) をパスしない <span class="math">\(\gcd(a,n)=1\)</span> の <span class="math">\(a\)</span> があれば, <span class="math">\(n\)</span> は素数ではない」といえる. 
たとえば, <span class="math">\(n=15\)</span> とすると <span class="math">\(2^{15-1}\equiv 2^{14}\equiv 4\not\equiv 1\pmod{15}\)</span> であるから <span class="math">\(15\)</span> は素数ではない. しかしながら, <span class="math">\(^\forall a\left(\gcd(a,n)=1\right)\)</span> に対して \(FT_n(a)\) をパスしても <span class="math">\(n\)</span> が素数であるとは断言できない.&nbsp;このような</p>
<div class="panel panel-default">
  <div class="panel-heading def"><a class="disabled">カーマイケル数</a></div>
  <div class="panel-body" style="overflow:scroll">
&#92;(^\forall a\left(\gcd(n, a)=1\right)&#92;) に対して &#92;(FT_n(a)&#92;) をパスする合成数
  </div>
</div>

<p>をカーマイケル数という. 一般的に, そのような <span class="math">\(n\)</span> は少ないことが知られている.
ところで,&nbsp;カーマイケル数は奇数である.</p>
<div class="panel panel-default">
  <div class="panel-heading prop"><a class="disabled" id="prop2">命題 2</a></div>
  <div class="panel-body" style="overflow:scroll">
    カーマイケル数は奇数
</div>
</div>

<p><strong>証明</strong>: <span class="math">\(a^n\equiv a\pmod{n}\)</span> に <span class="math">\(a=n-1\)</span> を代入すると <span class="math">\((-1)^n\equiv -1\pmod{n}\)</span> となるが,
このとき <span class="math">\(n\)</span> を偶数とすると <span class="math">\(1\equiv -1\pmod{n}\)</span> となってしまい不条理. <span class="math">\(\therefore\)</span> 背理により題意は示された.&nbsp;\(\square\)</p>
<p>一方, 
<div class="panel panel-default">
  <div class="panel-heading def"><a class="disabled">\(a\) を底とする偽素数</a></div>
  <div class="panel-body" style="overflow:scroll">
\(\gcd(n, a)=1\) のある \(a\) に対して \(FT_n(a)\) をパスする合成数
  </div>
</div>
を <span class="math">\(a\)</span>&nbsp;を底とする偽素数という. </p>
<p>以下で, 取り敢えず <span class="math">\(200\)</span> 個の偽素数(結果的にはカーマイケル数)を<a class="disabled" name="modexpref">得てみた</a><sup id="fnref-12"><a class="footnote-ref" href="#fn-12">12</a></sup>. </p>
<div class="highlight"><pre><span></span><span class="cm">{-# OPTIONS_GHC -Wall #-}</span>
<span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Data.Numbers.Primes</span> <span class="p">(</span><span class="nf">primes</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Bits</span> <span class="p">(</span><span class="kt">Bits</span><span class="p">,</span> <span class="p">(</span><span class="o">.&amp;.</span><span class="p">),</span> <span class="nf">shiftR</span><span class="p">)</span>

<span class="cm">{-# INLINE modExp #-}</span>
<span class="nf">modExp</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Integral</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Bits</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
<span class="nf">modExp</span> <span class="ow">=</span> <span class="n">go</span> <span class="mi">1</span>
    <span class="kr">where</span>
        <span class="n">go</span> <span class="n">r</span> <span class="kr">_</span> <span class="mi">0</span> <span class="kr">_</span> <span class="ow">=</span> <span class="n">r</span>
        <span class="n">go</span> <span class="n">r</span> <span class="n">x</span> <span class="n">n</span> <span class="n">m</span>
            <span class="o">|</span> <span class="n">n</span> <span class="o">.&amp;.</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">=</span> <span class="n">go</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">x</span> <span class="p">`</span><span class="n">rem</span><span class="p">`</span> <span class="n">m</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="p">`</span><span class="n">rem</span><span class="p">`</span> <span class="n">m</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">1</span><span class="p">)</span> <span class="n">m</span>
            <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="n">go</span> <span class="n">r</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="p">`</span><span class="n">rem</span><span class="p">`</span> <span class="n">m</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">1</span><span class="p">)</span> <span class="n">m</span>

<span class="cm">{-# INLINE isFermat #-}</span>
<span class="nf">isFermat</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Integral</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Bits</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">isFermat</span> <span class="n">n</span> <span class="n">b</span> <span class="ow">=</span> <span class="n">modExp</span> <span class="n">b</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span>

<span class="nf">pseudoprimes</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Integer</span><span class="p">]</span>
<span class="nf">pseudoprimes</span> <span class="ow">=</span> <span class="n">go</span> <span class="p">[</span><span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">2</span><span class="o">..</span><span class="p">],</span> <span class="n">odd</span> <span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="n">primes</span><span class="p">,</span> <span class="n">odd</span> <span class="n">x</span><span class="p">]</span>
    <span class="kr">where</span>
        <span class="n">tryFermat</span> <span class="n">n</span> <span class="n">t</span> <span class="ow">=</span> <span class="n">all</span> <span class="p">(</span><span class="n">isFermat</span> <span class="n">n</span><span class="p">)</span> <span class="o">$</span> <span class="n">take</span> <span class="n">t</span> <span class="p">[</span><span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">2</span><span class="o">..</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gcd</span> <span class="n">x</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">go</span> <span class="kt">[]</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">[]</span>
        <span class="n">go</span> <span class="kr">_</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="kt">[]</span>
        <span class="n">go</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="kt">:</span><span class="n">ps</span><span class="p">)</span> 
            <span class="o">|</span> <span class="n">x</span> <span class="o">==</span> <span class="n">p</span> <span class="ow">=</span> <span class="n">go</span> <span class="n">xs</span> <span class="n">ps</span> 
            <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="kr">if</span> <span class="n">tryFermat</span> <span class="n">x</span> <span class="mi">100</span> <span class="kr">then</span> <span class="n">x</span> <span class="kt">:</span> <span class="n">go</span> <span class="n">xs</span> <span class="p">(</span><span class="n">p</span><span class="kt">:</span><span class="n">ps</span><span class="p">)</span> <span class="kr">else</span> <span class="n">go</span> <span class="n">xs</span> <span class="p">(</span><span class="n">p</span><span class="kt">:</span><span class="n">ps</span><span class="p">)</span> <span class="c1">-- Testing 100 times</span>

<span class="nf">main</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">main</span> <span class="ow">=</span> <span class="n">print</span> <span class="o">$</span> <span class="n">take</span> <span class="mi">200</span> <span class="n">pseudoprimes</span>
</pre></div>


<p>実行結果.</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">561</span><span class="p">,</span><span class="mi">1105</span><span class="p">,</span><span class="mi">1729</span><span class="p">,</span><span class="mi">2465</span><span class="p">,</span><span class="mi">2821</span><span class="p">,</span><span class="mi">6601</span><span class="p">,</span><span class="mi">8911</span><span class="p">,</span><span class="mi">10585</span><span class="p">,</span><span class="mi">15841</span><span class="p">,</span><span class="mi">29341</span><span class="p">,</span><span class="mi">41041</span><span class="p">,</span><span class="mi">46657</span><span class="p">,</span><span class="mi">52633</span><span class="p">,</span><span class="mi">62745</span><span class="p">,</span><span class="mi">63973</span><span class="p">,</span><span class="mi">75361</span><span class="p">,</span><span class="mi">101101</span><span class="p">,</span><span class="mi">115921</span><span class="p">,</span><span class="mi">126217</span><span class="p">,</span><span class="mi">162401</span><span class="p">,</span><span class="mi">172081</span><span class="p">,</span><span class="mi">188461</span><span class="p">,</span><span class="mi">252601</span><span class="p">,</span><span class="mi">278545</span><span class="p">,</span><span class="mi">294409</span><span class="p">,</span><span class="mi">314821</span><span class="p">,</span><span class="mi">334153</span><span class="p">,</span><span class="mi">340561</span><span class="p">,</span><span class="mi">399001</span><span class="p">,</span><span class="mi">410041</span><span class="p">,</span><span class="mi">449065</span><span class="p">,</span><span class="mi">488881</span><span class="p">,</span><span class="mi">512461</span><span class="p">,</span><span class="mi">530881</span><span class="p">,</span><span class="mi">552721</span><span class="p">,</span><span class="mi">656601</span><span class="p">,</span><span class="mi">658801</span><span class="p">,</span><span class="mi">670033</span><span class="p">,</span><span class="mi">748657</span><span class="p">,</span><span class="mi">825265</span><span class="p">,</span><span class="mi">838201</span><span class="p">,</span><span class="mi">852841</span><span class="p">,</span><span class="mi">997633</span><span class="p">,</span><span class="mi">1024651</span><span class="p">,</span><span class="mi">1033669</span><span class="p">,</span><span class="mi">1050985</span><span class="p">,</span><span class="mi">1082809</span><span class="p">,</span><span class="mi">1152271</span><span class="p">,</span><span class="mi">1193221</span><span class="p">,</span><span class="mi">1461241</span><span class="p">,</span><span class="mi">1569457</span><span class="p">,</span><span class="mi">1615681</span><span class="p">,</span><span class="mi">1773289</span><span class="p">,</span><span class="mi">1857241</span><span class="p">,</span><span class="mi">1909001</span><span class="p">,</span><span class="mi">2100901</span><span class="p">,</span><span class="mi">2113921</span><span class="p">,</span><span class="mi">2433601</span><span class="p">,</span><span class="mi">2455921</span><span class="p">,</span><span class="mi">2508013</span><span class="p">,</span><span class="mi">2531845</span><span class="p">,</span><span class="mi">2628073</span><span class="p">,</span><span class="mi">2704801</span><span class="p">,</span><span class="mi">3057601</span><span class="p">,</span><span class="mi">3146221</span><span class="p">,</span><span class="mi">3224065</span><span class="p">,</span><span class="mi">3581761</span><span class="p">,</span><span class="mi">3664585</span><span class="p">,</span><span class="mi">3828001</span><span class="p">,</span><span class="mi">4335241</span><span class="p">,</span><span class="mi">4463641</span><span class="p">,</span><span class="mi">4767841</span><span class="p">,</span><span class="mi">4903921</span><span class="p">,</span><span class="mi">4909177</span><span class="p">,</span><span class="mi">5031181</span><span class="p">,</span><span class="mi">5049001</span><span class="p">,</span><span class="mi">5148001</span><span class="p">,</span><span class="mi">5310721</span><span class="p">,</span><span class="mi">5444489</span><span class="p">,</span><span class="mi">5481451</span><span class="p">,</span><span class="mi">5632705</span><span class="p">,</span><span class="mi">5968873</span><span class="p">,</span><span class="mi">6049681</span><span class="p">,</span><span class="mi">6054985</span><span class="p">,</span><span class="mi">6189121</span><span class="p">,</span><span class="mi">6313681</span><span class="p">,</span><span class="mi">6733693</span><span class="p">,</span><span class="mi">6840001</span><span class="p">,</span><span class="mi">6868261</span><span class="p">,</span><span class="mi">7207201</span><span class="p">,</span><span class="mi">7519441</span><span class="p">,</span><span class="mi">7995169</span><span class="p">,</span><span class="mi">8134561</span><span class="p">,</span><span class="mi">8341201</span><span class="p">,</span><span class="mi">8355841</span><span class="p">,</span><span class="mi">8719309</span><span class="p">,</span><span class="mi">8719921</span><span class="p">,</span><span class="mi">8830801</span><span class="p">,</span><span class="mi">8927101</span><span class="p">,</span><span class="mi">9439201</span><span class="p">,</span><span class="mi">9494101</span><span class="p">,</span><span class="mi">9582145</span><span class="p">,</span><span class="mi">9585541</span><span class="p">,</span><span class="mi">9613297</span><span class="p">,</span><span class="mi">9890881</span><span class="p">,</span><span class="mi">10024561</span><span class="p">,</span><span class="mi">10267951</span><span class="p">,</span><span class="mi">10402561</span><span class="p">,</span><span class="mi">10606681</span><span class="p">,</span><span class="mi">10837321</span><span class="p">,</span><span class="mi">10877581</span><span class="p">,</span><span class="mi">11119105</span><span class="p">,</span><span class="mi">11205601</span><span class="p">,</span><span class="mi">11921001</span><span class="p">,</span><span class="mi">11972017</span><span class="p">,</span><span class="mi">12261061</span><span class="p">,</span><span class="mi">12262321</span><span class="p">,</span><span class="mi">12490201</span><span class="p">,</span><span class="mi">12945745</span><span class="p">,</span><span class="mi">13187665</span><span class="p">,</span><span class="mi">13696033</span><span class="p">,</span><span class="mi">13992265</span><span class="p">,</span><span class="mi">14469841</span><span class="p">,</span><span class="mi">14676481</span><span class="p">,</span><span class="mi">14913991</span><span class="p">,</span><span class="mi">15247621</span><span class="p">,</span><span class="mi">15403285</span><span class="p">,</span><span class="mi">15829633</span><span class="p">,</span><span class="mi">15888313</span><span class="p">,</span><span class="mi">16046641</span><span class="p">,</span><span class="mi">16778881</span><span class="p">,</span><span class="mi">17098369</span><span class="p">,</span><span class="mi">17236801</span><span class="p">,</span><span class="mi">17316001</span><span class="p">,</span><span class="mi">17586361</span><span class="p">,</span><span class="mi">17812081</span><span class="p">,</span><span class="mi">18162001</span><span class="p">,</span><span class="mi">18307381</span><span class="p">,</span><span class="mi">18900973</span><span class="p">,</span><span class="mi">19384289</span><span class="p">,</span><span class="mi">19683001</span><span class="p">,</span><span class="mi">20964961</span><span class="p">,</span><span class="mi">21584305</span><span class="p">,</span><span class="mi">22665505</span><span class="p">,</span><span class="mi">23382529</span><span class="p">,</span><span class="mi">25603201</span><span class="p">,</span><span class="mi">26280073</span><span class="p">,</span><span class="mi">26474581</span><span class="p">,</span><span class="mi">26719701</span><span class="p">,</span><span class="mi">26921089</span><span class="p">,</span><span class="mi">26932081</span><span class="p">,</span><span class="mi">27062101</span><span class="p">,</span><span class="mi">27336673</span><span class="p">,</span><span class="mi">27402481</span><span class="p">,</span><span class="mi">28787185</span><span class="p">,</span><span class="mi">29020321</span><span class="p">,</span><span class="mi">29111881</span><span class="p">,</span><span class="mi">31146661</span><span class="p">,</span><span class="mi">31405501</span><span class="p">,</span><span class="mi">31692805</span><span class="p">,</span><span class="mi">32914441</span><span class="p">,</span><span class="mi">33302401</span><span class="p">,</span><span class="mi">33596641</span><span class="p">,</span><span class="mi">34196401</span><span class="p">,</span><span class="mi">34657141</span><span class="p">,</span><span class="mi">34901461</span><span class="p">,</span><span class="mi">35571601</span><span class="p">,</span><span class="mi">35703361</span><span class="p">,</span><span class="mi">36121345</span><span class="p">,</span><span class="mi">36765901</span><span class="p">,</span><span class="mi">37167361</span><span class="p">,</span><span class="mi">37280881</span><span class="p">,</span><span class="mi">37354465</span><span class="p">,</span><span class="mi">37964809</span><span class="p">,</span><span class="mi">38151361</span><span class="p">,</span><span class="mi">38624041</span><span class="p">,</span><span class="mi">38637361</span><span class="p">,</span><span class="mi">39353665</span><span class="p">,</span><span class="mi">40160737</span><span class="p">,</span><span class="mi">40280065</span><span class="p">,</span><span class="mi">40430401</span><span class="p">,</span><span class="mi">40622401</span><span class="p">,</span><span class="mi">40917241</span><span class="p">,</span><span class="mi">41298985</span><span class="p">,</span><span class="mi">41341321</span><span class="p">,</span><span class="mi">41471521</span><span class="p">,</span><span class="mi">42490801</span><span class="p">,</span><span class="mi">43286881</span><span class="p">,</span><span class="mi">43331401</span><span class="p">,</span><span class="mi">43584481</span><span class="p">,</span><span class="mi">43620409</span><span class="p">,</span><span class="mi">44238481</span><span class="p">,</span><span class="mi">45318561</span><span class="p">,</span><span class="mi">45877861</span><span class="p">,</span><span class="mi">45890209</span><span class="p">,</span><span class="mi">46483633</span><span class="p">,</span><span class="mi">47006785</span><span class="p">,</span><span class="mi">48321001</span><span class="p">,</span><span class="mi">48628801</span><span class="p">,</span><span class="mi">49333201</span><span class="p">]</span>
</pre></div>


<p>続いて, Miller-Rabin 法について述べる. 
前述したように, Miller-Rabin 法は, フェルマーテストの改良である. 
そもそも, いま判定する <span class="math">\(n\)</span> は奇数である前提をおいて十分であるから <span class="math">\(n-1\)</span> は偶数となり,
かつ <span class="math">\((n-1) \div 2\)</span> の結果は整数とすることができる. 
したがって \[\displaystyle a^{n-1}\equiv 1\pmod{n}\Rightarrow {\underbrace{\left(a^{(n-1)/2}\bmod n\right)}_{x}}^2 \equiv 1\pmod{n}\label{eq:fourth}\tag{4}\] がいえる. 
例えば, <span class="math">\(\eqref{eq:fourth}\)</span> の右側の式に着目し, <span class="math">\(n=35\)</span> とすると, <span class="math">\(x\)</span> は <span class="math">\(\overline{1},\overline{6},\overline{29},\overline{34}\)</span> が <span class="math">\(2\)</span> 乗すると <span class="math">\(\overline{1}\)</span> となるため, 有りうる.
しかし, <span class="math">\(n\)</span> が奇素数であるとき, その剰余類は <span class="math">\(\pm{\overline{1}}\)</span> しか有りえないのである. 
これは,&nbsp;次の命題の証明によって証明される.</p>
<div class="panel panel-default">
  <div class="panel-heading prop"><a class="disabled" id="prop3">命題 3</a></div>
  <div class="panel-body" style="overflow:scroll">
法 &#92;(n&#92;) が奇素数であるとき, その剰余において「&#92;(1&#92;) の自明でない平方根は存在しない. 
&#92;(\Leftrightarrow\ x&#92;) は &#92;(\pm{1}&#92;) しか存在しえない.」.
</div>
</div>

<p><strong>証明</strong>: <span class="math">\(n\)</span> を法とした剰余において <span class="math">\(1\pmod{n}\)</span> の非自明な平方根を <span class="math">\(x\)</span> とすると \[x^2\equiv 1\pmod{n}=x^2-1\equiv 0\pmod{n}=\left(x-1\right)\left(x+1\right)\equiv 0\pmod{n}\] において, <span class="math">\(n\)</span> は素数であるから <span class="math">\(x-1\)</span> または <span class="math">\(x+1\)</span> で割り切れなければならないが, <span class="math">\(x\)</span> が <span class="math">\(\pm{1}\)</span> でないとすると, <span class="math">\(x-1\)</span> も <span class="math">\(x+1\)</span> も <span class="math">\(n\)</span> で割り切れず矛盾. <span class="math">\(\therefore\)</span> 背理により, 題意は示された.&nbsp;\(\square\)</p>
<p>Miller-Rabin 法は, この性質を利用して, つまり <span class="math">\(1\pmod{n}\)</span> の自明でない平方根を求めることで, 合成数を判別する. 先に述べたように <span class="math">\(n-1\)</span> は偶数であるから, 何度か必ず <span class="math">\(2\)</span> で割り切ることができる. 
割り切る回数を <span class="math">\(s\)</span>&nbsp;とすると, </p>
<div class="math">$$n-1 = 2^s \cdot d\ (s\in\mathbb{N}, d\ is\ odd)\label{eq:fifth}\tag{5}$$</div>
<p> と表せる. 
このときの <span class="math">\(d\)</span> は, <span class="math">\(n-1\)</span> を繰り返し <span class="math">\(2\)</span> で割った結果そのものである.
フェルマーの小定理 <span class="math">\(\eqref{eq:second}\)</span> を <span class="math">\(\eqref{eq:fifth}\)</span>&nbsp;と関連づけると,
</p>
<div class="math">$$a^{n-1}\equiv a^{2^s\cdot d}\equiv 1\pmod{n}$$</div>
<p> がいえる. 
<a href="#prop3">命題 3</a> より, この平方根は <span class="math">\(\pm{1}\pmod{n}\)</span> である.&nbsp;つまり, </p>
<div class="panel panel-default">
  <div class="panel-heading theo"><a class="disabled">Miller-Rabin 素数判定法</a></div>
  <div class="panel-body" style="overflow:scroll">
&#92;(^\forall a \in \mathbb{Z}^{\ast}_{n}&#92;) について $$a^d\equiv 1\pmod{n}$$ または $$a^{2^r\cdot d}\equiv -1\pmod{n}\ (0\leq r\leq s-1)$$ が成り立つ. 
  </div>
</div>

<p>これは, 予め <span class="math">\(a^d\)</span> から始めて次々に <span class="math">\(2\)</span> 乗して得られる列
\(a^d,\underbrace{\cdots, a^{2^{s-1}\cdot d}}_{s}, a^{2^s\cdot d}=a^{n-1}\) を想像すると,&nbsp;考えるに容易い. </p>
<p>例として, 先に確認できた最小のカーマイケル数である
<span class="math">\(561\)</span> をこのミラーラビン法で判定してみるとする. 
<span class="math">\(n=561,\ a=2\)</span> としたとき, <span class="math">\(561-1=2^4\cdot 35\)</span> であるから, 
<span class="math">\(2^{35}\equiv 263\pmod{561}\)</span>, <span class="math">\(2^{2\cdot 35}\equiv 263^2\equiv 166\pmod{561}\)</span>,
<span class="math">\(2^{4\cdot 35}\equiv 166^2\equiv 67\pmod{561}\)</span>, 
<span class="math">\(2^{8\cdot 35}\equiv 67^2\equiv 1\pmod{561}\)</span> より条件を満たさない.
よって <span class="math">\(a=2\)</span> により, <span class="math">\(n=561\)</span>&nbsp;が合成数であることがわかった.</p>
<p>いま述べたように, この手続きで <span class="math">\(n\)</span> が合成数であることがわかったとき,
<span class="math">\(a\)</span> を <i>witness</i> と言い, そうでないとき <span class="math">\(a\)</span> を <i>strong liar</i>, 
<span class="math">\(n\)</span> を <i>strong pseudoprime</i> という<sup id="fnref-13"><a class="footnote-ref" href="#fn-13">13</a></sup>. 
すべての合成数には, 多くの <i>witness</i> である <span class="math">\(a\)</span> が存在することが知られているが,
そのような <span class="math">\(a\)</span> を生成する簡単な方法はまだ知られていない<sup id="fnref-14"><a class="footnote-ref" href="#fn-14">14</a></sup>ため, 
この <span class="math">\(a\)</span> は, いま例で述べたように \(^\forall a\in \mathbb{Z}^{\ast}_{n}\) または
\(^\forall a\in \left(\mathbb{Z}^{\ast}_{n}\setminus \left\{1 \right\}\right)\)
からランダムに取って, 何度かの試行を行うこととなる. 
しかし <span class="math">\(n\)</span> が小さい場合, 特定のいくつかの <i>witness</i>
によるテストで十分であることが知られており<sup id="fnref-15"><a class="footnote-ref" href="#fn-15">15</a></sup>,
その場合, すべての <span class="math">\(a&lt;2\left(\ln n\right)^2\)</span>&nbsp;を試みる必要はない.</p>
<p>以下にミラーラビン法を用いた素数生成の実装例を示す.
今述べたように, 特定のいくつかの <i>witness</i> マジックナンバーを利用することで,&nbsp;演算の高速化を図っている.</p>
<p>なおミラーラビン法の試行回数に関してであるが, 
下記の実装では, <span class="math">\(t\)</span> を試行回数, <span class="math">\(|p|\)</span> を得たい素数 <span class="math">\(p\)</span>
のビット長としたとき, <span class="math">\(|p|\geq 3072\)</span> で <span class="math">\(t=64\)</span>, <span class="math">\(3071\geq |p|\geq2048\)</span> で <span class="math">\(t=56\)</span>, 
それ以外を <span class="math">\(t=40\)</span> とした<sup id="fnref-16"><a class="footnote-ref" href="#fn-16">16</a></sup>.
ただし, <span class="math">\(n\)</span> の値がマジックナンバーに当てはまる値であった場合,
いま設定した試行回数を無視して,&nbsp;より少ない回数で試行を実行することとしている.</p>
<div class="highlight"><pre><span></span><span class="c1">-- miller.hs</span>
<span class="cm">{-# OPTIONS_GHC -Wall #-}</span>
<span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Data.Tuple.Extra</span> <span class="p">(</span><span class="nf">first</span><span class="p">,</span> <span class="nf">second</span><span class="p">,</span> <span class="nf">dupe</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Bool</span> <span class="p">(</span><span class="nf">bool</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Bits</span> <span class="p">(</span><span class="kt">Bits</span><span class="p">,</span> <span class="p">(</span><span class="o">.&amp;.</span><span class="p">),</span> <span class="p">(</span><span class="o">.|.</span><span class="p">),</span> <span class="nf">shiftR</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Fix</span> <span class="p">(</span><span class="nf">fix</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">System.Random</span> <span class="p">(</span><span class="kt">Random</span><span class="p">,</span> <span class="nf">randomRs</span><span class="p">,</span> <span class="nf">newStdGen</span><span class="p">,</span> <span class="nf">randomRIO</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">System.IO.Unsafe</span> <span class="p">(</span><span class="nf">unsafePerformIO</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Control.Monad</span> <span class="p">(</span><span class="nf">void</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">System.Environment</span> <span class="p">(</span><span class="nf">getArgs</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">BitSize</span> <span class="ow">=</span> <span class="kt">Int</span>

<span class="cm">{-# INLINE witnesses #-}</span>
<span class="nf">witnesses</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Num</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Enum</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Random</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="nf">witnesses</span> <span class="n">t</span> <span class="n">n</span> 
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2047</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1373653</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">9080191</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mi">73</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">25326001</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3215031751</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4759123141</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">61</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1122004669633</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1662803</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2152302898747</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3474749660383</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">341550071728321</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3825123056546413051</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">18446744073709551616</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">318665857834031151167461</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3317044064679887385961981</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">41</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="n">take</span> <span class="n">t</span> <span class="o">.</span> <span class="n">randomRs</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">pred</span> <span class="n">n</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">newStdGen</span>

<span class="cm">{-# INLINE millerRabin&#39; #-}</span>
<span class="nf">millerRabin&#39;</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Integer</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">millerRabin&#39;</span> <span class="n">t</span> <span class="n">n</span> <span class="ow">=</span> <span class="n">unsafePerformIO</span> <span class="o">$</span> <span class="n">millerRabin</span> <span class="n">t</span> <span class="n">n</span>

<span class="nf">millerRabin</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Integer</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Bool</span>
<span class="nf">millerRabin</span> <span class="kr">_</span> <span class="mi">0</span> <span class="ow">=</span> <span class="n">return</span> <span class="kt">False</span>
<span class="nf">millerRabin</span> <span class="kr">_</span> <span class="mi">1</span> <span class="ow">=</span> <span class="n">return</span> <span class="kt">False</span>
<span class="nf">millerRabin</span> <span class="n">t</span> <span class="n">n</span>
    <span class="o">|</span> <span class="n">even</span> <span class="n">n</span> <span class="ow">=</span> <span class="n">return</span> <span class="o">$</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="n">all</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">uncurry</span> <span class="p">(</span><span class="o">||</span><span class="p">)</span> <span class="o">.</span> <span class="n">first</span> <span class="p">(</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">.</span> <span class="n">second</span> <span class="p">(</span><span class="o">==</span><span class="n">pred</span> <span class="n">n</span><span class="p">)</span> <span class="o">.</span> <span class="n">dupe</span> <span class="o">.</span> <span class="n">flip</span> <span class="p">(`</span><span class="n">modExp</span><span class="p">`</span> <span class="n">q</span><span class="p">)</span> <span class="n">n</span><span class="p">)</span> <span class="n">a</span> <span class="o">||</span> 
        <span class="n">any</span> <span class="p">((</span><span class="o">==</span><span class="n">pred</span> <span class="n">n</span><span class="p">)</span> <span class="o">.</span> <span class="n">flip</span> <span class="p">(</span><span class="n">modExp</span> <span class="n">a</span><span class="p">)</span> <span class="n">n</span> <span class="o">.</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">)</span> <span class="o">.</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="p">))</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">pred</span> <span class="n">k</span><span class="p">])</span> <span class="o">&lt;$&gt;</span> <span class="n">witnesses</span> <span class="n">t</span> <span class="n">n</span>
    <span class="kr">where</span> 
        <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="ow">=</span> <span class="n">first</span> <span class="p">(</span><span class="n">pred</span> <span class="o">.</span> <span class="n">length</span><span class="p">)</span> <span class="o">.</span> <span class="n">second</span> <span class="p">(</span><span class="n">fst</span> <span class="o">.</span> <span class="n">last</span><span class="p">)</span> <span class="o">.</span> <span class="n">dupe</span> <span class="o">$</span> 
            <span class="n">takeWhile</span> <span class="p">((</span><span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span> <span class="n">snd</span><span class="p">)</span> <span class="o">$</span> <span class="n">iterate</span> <span class="p">((`</span><span class="n">quotRem</span><span class="p">`</span> <span class="mi">2</span><span class="p">)</span> <span class="o">.</span> <span class="n">fst</span><span class="p">)</span> <span class="p">(</span><span class="n">pred</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 

<span class="cm">{-# INLINE genRndPrime #-}</span>
<span class="nf">genRndPrime</span> <span class="ow">::</span> <span class="kt">BitSize</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Integer</span>
<span class="nf">genRndPrime</span> <span class="n">b</span> <span class="ow">=</span> <span class="kr">let</span> <span class="n">t</span> <span class="o">|</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">3071</span> <span class="ow">=</span> <span class="mi">64</span> <span class="o">|</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">2047</span> <span class="ow">=</span> <span class="mi">56</span> <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="mi">40</span> <span class="kr">in</span>
    <span class="n">fix</span> <span class="o">$</span> <span class="nf">\</span><span class="n">loop</span> <span class="ow">-&gt;</span> <span class="n">uncurry</span> <span class="p">(</span><span class="n">bool</span> <span class="n">loop</span><span class="p">)</span> <span class="o">.</span> <span class="n">first</span> <span class="n">return</span> <span class="o">.</span> <span class="n">second</span> <span class="p">(</span><span class="n">millerRabinV</span> <span class="n">t</span><span class="p">)</span> <span class="o">.</span> <span class="n">dupe</span> <span class="o">=&lt;&lt;</span> <span class="p">(</span><span class="o">.|.</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">randomRIO</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="n">pred</span> <span class="n">b</span><span class="p">,</span> <span class="n">pred</span> <span class="mi">2</span><span class="o">^</span><span class="n">b</span><span class="p">)</span>

<span class="nf">main</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">main</span> <span class="ow">=</span> <span class="n">void</span> <span class="o">.</span> <span class="n">genRndPrime</span> <span class="o">.</span> <span class="n">read</span> <span class="o">.</span> <span class="n">head</span> <span class="o">=&lt;&lt;</span> <span class="n">getArgs</span> <span class="c1">-- NOTE: Simplefied implementation</span>
</pre></div>


<p>禁断の<code>unsafePerformIO</code>を使っているが, Haskell によるミラーラビン法の実装をいくつか見たところ, 乱択部分を除いてしまうか, <code>unsafePerformIO</code>でむりやり剥がすかのどちらかであるものが多かったため, 今回は<code>unsafePerformIO</code>を使った. 
取り敢えず, <span class="math">\(512\)</span> ビットの素数(厳密には, ミラーラビン法をパスした整数値)を <span class="math">\(500\)</span> 個生成して, <span class="math">\(1\)</span> 個毎の平均タイムを取ってみる(Intel Core i5 2.3&nbsp;GHz).</p>
<div class="highlight"><pre><span></span>$ ghc -O2 miller.hs
$ <span class="k">function</span> <span class="nb">test</span> <span class="o">()</span> <span class="o">{</span> <span class="nv">c</span><span class="o">=</span><span class="k">$((</span><span class="nv">$1</span><span class="k">))</span><span class="p">;</span> <span class="nv">sum</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> i&lt;c<span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span> <span class="nv">t</span><span class="o">=</span><span class="sb">`</span><span class="o">(</span><span class="nb">time</span> <span class="nv">$2</span> <span class="nv">$3</span><span class="o">)</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f <span class="m">3</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/s//&#39;</span><span class="sb">`</span><span class="p">;</span> <span class="nv">sum</span><span class="o">=</span><span class="k">$((</span><span class="nv">$sum</span> <span class="o">+</span> <span class="nv">$t</span><span class="k">))</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="nb">echo</span> <span class="k">$((</span><span class="nv">$sum</span> <span class="o">/</span> <span class="nv">$c</span><span class="k">))</span> <span class="o">}</span>
$ <span class="nb">test</span> <span class="m">500</span> ./miller <span class="m">512</span>
<span class="m">0</span>.15404000000000001
</pre></div>


<p>続いて, <span class="math">\(128, 256, 512, 1024, 2048, 4096\)</span>&nbsp;ビットの素数(厳密には(略))を出力してみる.</p>
<div class="highlight"><pre><span></span>Prelude&gt; :l miller.hs
<span class="o">[</span><span class="m">1</span> of <span class="m">1</span><span class="o">]</span> Compiling Main             <span class="o">(</span> miller.hs, interpreted <span class="o">)</span>
Ok, one module loaded.
*Main&gt; :m +Control.Monad
*Main Control.Monad&gt; mapM_ <span class="o">(</span>print &lt;<span class="o">=</span>&lt; genRndPrime<span class="o">)</span> $ takeWhile <span class="o">(</span>&lt;<span class="o">=</span><span class="m">4096</span><span class="o">)</span> $ iterate <span class="o">(</span>*2<span class="o">)</span> <span class="m">128</span>
<span class="m">30152684759236306360759189014885017501</span>
<span class="m">17615060719467184202036409862717012145510462718555435021180440677751843010823</span>
<span class="m">4961148527316039571648091952671338492606036840037640470424610573222347642611462698736307409917945445030462370397146417013342380935544024541068881582286519</span>
<span class="m">25584768656119199916533897521508744971267476837365238305752308490292510217984396186262212951588772839265133033518832638176737141863211711861885101826309901436466476910363387059212888058245199487348290889532831748995252985064885609741672898559944700898752387615008473235044774735893904621136647403330417312059</span>
<span class="m">9697176354766878597400959392092693913441120648813644414460016213663985294414931715402479614583881054693029546415327047217815927381224240226473707682349775659198547518238881984785480308932024810985466973637700641819036921605772405440708981576721445103440573178324949184257202763509431134454852179958292647936221069441068206326565638462179605127956309699241768323894074914089121556488610751882542364864592334186293707224875665902283108012729170475600277359162025423140429916611481557282284452570764357791923438513047955145544164761084918980627342758315952165604438369806429356467080379549163687769931548537357143263137</span>
<span class="m">249063954769520791504335518869525636357711675551382844552486591301599804010616669984965046137702990331634027801213287527508276332874010381824423879851102129301619320214358200683875526181170711209609115767952039460200494646156806401006606435356629905145570257996919209012879790948686386135358818589021439012221688336685244502459332857112750109146317838249983592404921237275755397945054535375511514580719834889033600717626042664029019643677615797489694358572078991851764302692237731943089490923440157248660837253585380337652421704176147487644881486339669614376151014612960159779210346160720078183845109588734694671896283469443712214250201417341560450455911188218652929963021457097285664257779489584361468840174197077267520538188995324746759329091599208318255773278559709364894821983283204708493843410191542232134827077779374883928282449194911733594690651507649566828266806932507531936170109029976882137339061468508458205917061060082555112142174457460359680430229131730389715061511723413089333837349054725383074218124443684705492930073805208443422200611436931245986942375223462067885041043866971617179685176389912228173339486617601365377174404775712644963980902603572250337835570653437536036543335033071576503380289418724779934391260111</span>
</pre></div>


<p>というわけで, 任意のビット数の素数(厳(略))が得られるようになった. 
ところで, これは完全に蛇足なのだが, 同様の実装を C++ で行えば,
これより少し早くなるのではないかと思い, 
Boost.Multiprecision 等を使って, この実装を C++ に移植しようと考えた. 
ただ, ミラーラビン法で素数を得る機能は, 既に同ライブラリ内で実装済みであったので,
一旦それを用いてタイムを計測して,&nbsp;お茶を濁すこととした. </p>
<div class="highlight"><pre><span></span><span class="c1">// miller.cpp</span>
<span class="cp">#include</span> <span class="cpf">&lt;boost/multiprecision/cpp_int.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;boost/multiprecision/miller_rabin.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;boost/random/mersenne_twister.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;boost/random/uniform_int_distribution.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;boost/random/random_device.hpp&gt;</span><span class="cp"></span>

<span class="k">constexpr</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">check_times</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s</span><span class="p">)</span> <span class="k">noexcept</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">3072</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">2048</span> <span class="o">?</span> <span class="mi">56</span> <span class="o">:</span> <span class="mi">40</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">**</span> <span class="k">const</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">namespace</span> <span class="n">bm</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">multiprecision</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">lexical_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">uniform_int_distribution</span><span class="o">&lt;</span><span class="n">bm</span><span class="o">::</span><span class="n">cpp_int</span><span class="o">&gt;</span> <span class="n">dist</span><span class="p">(</span><span class="n">bm</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">bm</span><span class="o">::</span><span class="n">cpp_int</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bm</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">bm</span><span class="o">::</span><span class="n">cpp_int</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">val</span><span class="p">));</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">random_device</span> <span class="n">seed</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">mt19937</span> <span class="n">mt</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">bm</span><span class="o">::</span><span class="n">cpp_int</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span> <span class="o">!</span><span class="n">bm</span><span class="o">::</span><span class="n">miller_rabin_test</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">check_times</span><span class="p">(</span><span class="n">val</span><span class="p">));</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">mt</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>


<p>若干ではあるが,&nbsp;やはり少しは早くなったようだ.</p>
<div class="highlight"><pre><span></span>$ g++-8 -std<span class="o">=</span>c++1z -lboost_random miller.cpp -I/usr/local/include -march<span class="o">=</span>native -O3 -Ofast
$ <span class="nb">test</span> <span class="m">500</span> ./a.out <span class="m">512</span>
<span class="m">0</span>.13506000000000004
</pre></div>


<p>さらに早さを求める場合, 実用途として利用でき, かつお手頃なもので良い選択になるものを考えると, 
やはり libgmp が思い浮かぶ<sup id="fnref-17"><a class="footnote-ref" href="#fn-17">17</a></sup>. 
ただ, 本エントリの内容のメインは素数生成に関してではないので,&nbsp;一旦ここまでとしておく.</p>
<h4>原始根の生成</h4>
<p>次に必要となるのは原始根 <span class="math">\(g\)</span> であるが, この生成を簡単にするためには, 
安全素数という素数を素数生成の段階で生成しておかなければならない<sup id="fnref2-7"><a class="footnote-ref" href="#fn-7">7</a></sup>.&nbsp;安全素数は</p>
<div class="panel panel-default">
  <div class="panel-heading def"><a class="disabled">安全素数</a></div>
  <div class="panel-body" style="overflow:scroll">
  &#92;(q=2p+1\ \left(p\ is\ prime\right)&#92;) があって, このとき素数となる &#92;(q&#92;)
  </div>
</div>

<p>をいう<sup id="fnref-18"><a class="footnote-ref" href="#fn-18">18</a></sup>.&nbsp;また, </p>
<div class="panel panel-default">
  <div class="panel-heading def"><a class="disabled">ソフィー・ジェルマン素数</a></div>
  <div class="panel-body" style="overflow:scroll">
  安全素数 &#92;(q=2p+1&#92;) の &#92;(p=(q-1)\div 2&#92;)
  </div>
</div>

<p>をソフィー・ジェルマン素数という. 例えば, <span class="math">\(p=11\)</span> としたとき
<span class="math">\(2\cdot 11+1=23\)</span> は素数であるから, <span class="math">\(q=23\)</span> を安全素数, 
また <span class="math">\(p=11\)</span> をソフィー・ジェルマン素数という.
素数生成の段階でこの安全素数を要するのは, 
原始根 <span class="math">\(g\)</span> を求める単純な一般式が知られておらず<sup id="fnref3-7"><a class="footnote-ref" href="#fn-7">7</a></sup>, 安全素数でない素数に対する原始根
<span class="math">\(g\)</span> の確定的な結果を要する場合, <a href="#thiscode">先に求めた</a>ように
\(g\not\equiv 1,\cdots,g^{p-2}\not\equiv 1\pmod{p}\) といった判定が必要となるからである.
<span class="math">\(q\)</span> が安全素数であれば, <span class="math">\(q-1=2p\)</span><sup id="fnref-19"><a class="footnote-ref" href="#fn-19">19</a></sup> より <span class="math">\(q-1\)</span> の素因数は <span class="math">\(2\)</span> と <span class="math">\(p=(q-1)\div 2\)</span>
しかなく, 圧倒的に計算量を減らすことができる.
さて, 安全素数は, <span class="math">\(p\)</span> と <span class="math">\(q\)</span> がともに素数であれば良いので, 
このどちらにもミラーラビン法を実行してしまうのが一番簡単である<sup id="fnref-20"><a class="footnote-ref" href="#fn-20">20</a></sup>.</p>
<div class="highlight"><pre><span></span><span class="c1">-- (略)</span>

<span class="cm">{-# INLINE genRndSafePrime #-}</span>
<span class="nf">genRndSafePrime</span> <span class="ow">::</span> <span class="kt">BitSize</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Integer</span>
<span class="nf">genRndSafePrime</span> <span class="n">b</span> <span class="ow">=</span> <span class="kr">let</span> <span class="n">t</span> <span class="o">|</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">3071</span> <span class="ow">=</span> <span class="mi">64</span> <span class="o">|</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">2047</span> <span class="ow">=</span> <span class="mi">56</span> <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="mi">40</span> <span class="kr">in</span>
    <span class="n">fix</span> <span class="o">$</span> <span class="nf">\</span><span class="n">loop</span> <span class="ow">-&gt;</span> <span class="n">uncurry</span> <span class="p">(</span><span class="n">bool</span> <span class="n">loop</span><span class="p">)</span> <span class="o">.</span> <span class="n">first</span> <span class="p">(</span><span class="n">return</span> <span class="o">.</span> <span class="n">fst</span><span class="p">)</span> <span class="o">.</span> <span class="n">second</span> <span class="n">snd</span> <span class="o">.</span> <span class="n">dupe</span> <span class="o">=&lt;&lt;</span> 
            <span class="n">second</span> <span class="p">(</span><span class="n">uncurry</span> <span class="p">(</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">.</span> <span class="n">first</span> <span class="p">(</span><span class="n">millerRabin&#39;</span> <span class="n">t</span> <span class="o">.</span> <span class="p">(</span><span class="n">flip</span> <span class="n">shiftR</span> <span class="mi">1</span><span class="p">)</span> <span class="o">.</span> <span class="n">pred</span><span class="p">)</span> <span class="o">.</span> <span class="n">second</span> <span class="p">(</span><span class="n">millerRabin&#39;</span> <span class="n">t</span><span class="p">)</span> <span class="o">.</span> <span class="n">dupe</span><span class="p">)</span> <span class="o">.</span>
                <span class="n">dupe</span> <span class="o">.</span> <span class="p">(</span><span class="o">.|.</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">randomRIO</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="n">pred</span> <span class="n">b</span><span class="p">,</span> <span class="n">pred</span> <span class="mi">2</span><span class="o">^</span><span class="n">b</span><span class="p">)</span>
</pre></div>


<p>これで, 任意のビット数の安全素数が得られるようになった.
あとは, この安全素数を利用して, <a href="#primitive_root">原始根の定義, 性質</a>に従い,
\(g^{q-1}\) で初めて \(g^{n}\equiv 1\pmod{q}\) となる <span class="math">\(g\)</span> を選べば良いわけであるが, 
その一連の手順としては, いま安全素数 <span class="math">\(q\)</span>&nbsp;があって</p>
<ol>
<li>任意の \(2\leq g\leq q-2\) を選ぶ(当然, <span class="math">\(1\)</span> と <span class="math">\(p-1\)</span> は\(g^2\equiv 1\pmod{q}\)&nbsp;となるから).</li>
<li>\(g^{(q-1)/2}\not\equiv 1\pmod{q}\) を満たすか判定する. これを満たせば <span class="math">\(g\)</span> は <span class="math">\(q\)</span> の原始根である. そうでなければ 1&nbsp;へ戻る.</li>
</ol>
<p>というように探索することができる.
このとき, 離散対数に対する耐性, すなわちセキュリティの強度に関して, 
この <span class="math">\(g\)</span> はとくに関与しないため, 通常小さい原始根から探し出せば良いことになる. 
すると, 次のようにして,&nbsp;最小の原始根が得られる.</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="kt">:</span><span class="n">m</span> <span class="o">+</span><span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span>
<span class="kt">Prelude</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="kt">:</span><span class="n">l</span> <span class="n">miller</span>
<span class="p">[</span><span class="mi">1</span> <span class="kr">of</span> <span class="mi">1</span><span class="p">]</span> <span class="kt">Compiling</span> <span class="kt">Main</span>             <span class="p">(</span> <span class="n">miller</span><span class="o">.</span><span class="n">hs</span><span class="p">,</span> <span class="n">interpreted</span> <span class="p">)</span>
<span class="kt">Ok</span><span class="p">,</span> <span class="n">one</span> <span class="kr">module</span> <span class="err">loaded.</span>
<span class="err">*</span><span class="nn">Main</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">2</span><span class="o">..</span><span class="mi">100</span><span class="p">],</span> <span class="n">millerRabin&#39;</span> <span class="mi">40</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">millerRabin&#39;</span> <span class="mi">40</span> <span class="p">(</span><span class="n">pred</span> <span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">1</span><span class="p">)]</span>
<span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">83</span><span class="p">]</span>
<span class="o">*</span><span class="kt">Main</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="kr">let</span> <span class="n">rootFromSafePrime</span> <span class="n">p</span> <span class="ow">=</span> <span class="n">head</span> <span class="p">[</span><span class="n">g</span> <span class="o">|</span> <span class="n">g</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">2</span><span class="o">..</span><span class="n">p</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">modExp</span> <span class="n">g</span> <span class="p">(</span><span class="n">pred</span> <span class="n">p</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">1</span><span class="p">)</span> <span class="n">p</span> <span class="o">/=</span> <span class="mi">1</span><span class="p">]</span>
<span class="o">*</span><span class="kt">Main</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">Bits</span><span class="o">&gt;</span> <span class="n">map</span> <span class="n">rootFromSafePrime</span>  <span class="p">[</span><span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">2</span><span class="o">..</span><span class="mi">100</span><span class="p">],</span> <span class="n">millerRabin&#39;</span> <span class="mi">40</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">millerRabin&#39;</span> <span class="mi">40</span> <span class="p">(</span><span class="n">pred</span> <span class="n">x</span> <span class="p">`</span>
<span class="nf">shiftR</span><span class="p">`</span> <span class="mi">1</span><span class="p">)]</span>
<span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
</pre></div>


<h4>鍵と暗号文の生成</h4>
<p>上で述べた手順のまま実装できる.</p>
<div class="highlight"><pre><span></span><span class="kr">type</span> <span class="kt">PublicKey</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">Integer</span><span class="p">,</span> <span class="kt">Integer</span><span class="p">,</span> <span class="kt">Integer</span><span class="p">)</span>
<span class="kr">type</span> <span class="kt">PrivateKey</span> <span class="ow">=</span> <span class="kt">Integer</span>
<span class="kr">type</span> <span class="kt">Keys</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">PublicKey</span><span class="p">,</span> <span class="kt">PrivateKey</span><span class="p">)</span>
<span class="kr">type</span> <span class="kt">Cryptogram</span> <span class="ow">=</span> <span class="p">[</span><span class="kt">Integer</span><span class="p">]</span>

<span class="nf">genKeys</span> <span class="ow">::</span> <span class="kt">Integer</span> <span class="ow">-&gt;</span> <span class="kt">Integer</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Keys</span>
<span class="nf">genKeys</span> <span class="n">p</span> <span class="n">g</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">a</span><span class="p">))</span> <span class="o">.</span> <span class="n">first</span> <span class="p">(</span><span class="n">flip</span> <span class="p">(</span><span class="n">modExp</span> <span class="n">g</span><span class="p">)</span> <span class="n">p</span><span class="p">)</span> <span class="o">.</span> <span class="n">dupe</span> <span class="o">&lt;$&gt;</span> <span class="n">randomRIO</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pred</span> <span class="n">p</span><span class="p">)</span>

<span class="nf">encode</span> <span class="ow">::</span> <span class="kt">PublicKey</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Cryptogram</span>
<span class="nf">encode</span> <span class="kr">_</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="n">return</span> <span class="kt">[]</span>
<span class="nf">encode</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="n">plain</span> <span class="ow">=</span> <span class="n">concat</span> <span class="o">&lt;$&gt;</span> <span class="n">mapM</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> 
    <span class="n">uncurry</span> <span class="p">(</span><span class="kt">:</span><span class="p">)</span> <span class="o">.</span> <span class="n">first</span> <span class="p">(</span><span class="n">flip</span> <span class="p">(</span><span class="n">modExp</span> <span class="n">g</span><span class="p">)</span> <span class="n">p</span><span class="p">)</span> <span class="o">.</span> 
        <span class="n">second</span> <span class="p">((</span><span class="kt">:[]</span><span class="p">)</span> <span class="o">.</span> <span class="n">flip</span> <span class="p">(</span><span class="n">flip</span> <span class="n">modExp</span> <span class="mi">1</span><span class="p">)</span> <span class="n">p</span> <span class="o">.</span> <span class="p">(</span><span class="n">toInteger</span> <span class="p">(</span><span class="n">ord</span> <span class="n">c</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span> <span class="o">.</span> <span class="n">flip</span> <span class="p">(</span><span class="n">modExp</span> <span class="n">y</span><span class="p">)</span> <span class="n">p</span><span class="p">)</span> <span class="o">.</span> 
            <span class="n">dupe</span> <span class="o">.</span> <span class="n">toInteger</span> <span class="o">&lt;$&gt;</span> <span class="n">randomRIO</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxBound</span> <span class="ow">::</span> <span class="kt">Int</span><span class="p">))</span> <span class="n">plain</span>
</pre></div>


<h4>暗号文の復号</h4>
<p>復号に関しても, 上の手順のまま実装するだけであるが,&nbsp;モジュラ逆数を得るために拡張ユークリッドの互除法を使うのでそれについて説明する.</p>
<p><span class="math">\(GF(p)\)</span> は体の公理より乗法について可換群となっており,
逆元が存在するはずだから, <span class="math">\(^\exists n\in GF(p)\)</span> に対する逆元を <span class="math">\(n^{-1}=x\in GF(p)\)</span> とおける.
<span class="math">\(GF(p)\)</span> の単位元を考えれば, この \(n\) と \(x\) の関係は, 
\(nx\equiv 1\pmod{m}\) という式で表せる.
この式は勿論, 合同の定義からして, <span class="math">\(k\)</span> をある整数としたとき 
\(nx-1=mk\) と等価であることがいえる. これを都合の良い形に移行すると, 
\(nx-mk=1\). いま知りたいのは, 逆数である <span class="math">\(x\)</span> だ. ここで, 拡張ユークリッドの互除法を使う.&nbsp;拡張ユークリッドの互除法は, </p>
<div class="panel panel-default">
  <div class="panel-heading def"><a class="disabled">拡張ユークリッドの互除法</a></div>
  <div class="panel-body" style="overflow:scroll">
<a href="#euclidean">ユークリッドの互除法</a>で求まる &#92;(\gcd(a,b)&#92;) に加え, &#92;[
ax+by=\gcd(a,b)
&#92;] (ベズーの等式) が成り立つ &#92;(a,\ b&#92;) のベズー係数 &#92;(x,\ y&#92;) をも同時に求める.
  </div>
</div>

<p>アルゴリズムである. 
いまの問題をこの式に当てはめると, \(nx-mk=\gcd(n,m)\) となる.
<a href="#genencanddec">暗号の生成と解読</a>の内容のうち例として用いた値,
<span class="math">\(n=10,\ m=97\)</span> を入力として, まず一般解を導いてみる.
いま <span class="math">\(n,\ m\)</span> に対して<a href="#euclidean">ユークリッドの互除法</a>を行うと,
</p>
<div class="math">\begin{eqnarray}
97&amp;=&amp;10\cdot 9+7&amp;\Leftrightarrow &amp;7&amp;=&amp;97-10\cdot 9\label{eq:ex1}\tag{6}\\\
10&amp;=&amp;7+3&amp;\Leftrightarrow &amp;3&amp;=&amp;10-7\label{eq:ex2}\tag{7}\\\
7&amp;=&amp;3\cdot 2+1&amp;\Leftrightarrow &amp;1&amp;=&amp;7-3\cdot 2\label{eq:ex3}\tag{8}
\end{eqnarray}</div>
<p>
より \[10x+97(-k)=1\] と表せる. こうして見るとわかるように, これは単なる <span class="math">\(1\)</span> 次不定方程式だ.
<span class="math">\(1\)</span> 次不定方程式は, \(\gcd(a,b)=d\) としたとき \(d=1\) ならば解がある.
また, \(d\gt 1,\ d\mid c\) でも解がある. 
なぜならば, \(d=\gcd(a,b)\) のときは<a href="#euclidean">ユークリッドの互除法</a>で解が構成できたし,
\(d\gt 1,\ d\mid c\) ならば <span class="math">\(d\)</span> 倍してやれば良いからだ.
逆に \(d\not\mid c\) ならば, その <span class="math">\(1\)</span> 次不定方程式は不能となる.
いま述べた例の場合,&nbsp;解は存在して,</p>
<div class="math">\begin{array}{lclclcl}
1&amp;=&amp;\eqref{eq:ex3}&amp;=&amp;7-3\cdot 2\\\
1&amp;=&amp;7-\eqref{eq:ex2}\cdot 2&amp;=&amp;7-(10-7)\cdot 2&amp;=&amp;7\cdot3 - 10\cdot 2\\\
1&amp;=&amp;\eqref{eq:ex1}\cdot 3-10\cdot 2&amp;=&amp;(97-10\cdot 9)\cdot 3-10\cdot 2&amp;=&amp;97\cdot 3-10\cdot 29 
\end{array}</div>
<p>
よって, 特別解 \(x=-29,\ k=-3\) が求まった. 
次に, この一般解を求める. いま求めた \(x,\ k\) を代入すると <span class="math">\(10(-29)+97(3)=1\)</span>.&nbsp;これを元の式から引くと,</p>
<div class="math">\begin{array}{rr}
&amp; 10x &amp;+ &amp;97(-k) &amp;= 1 \\\
-)&amp;10(-29) &amp;+ &amp;97(3) &amp;= 1
\\\hline
&amp;10(x+29)&amp;+&amp;97(-k-3)&amp;=0
\end{array}</div>
<p>で, 変形すると <span class="math">\(10(x+29)=-97(-k-3)\)</span> と表せる. 
ここで, 先のユークリッドの互除法により <span class="math">\(\gcd(10,97)=1\)</span> であることがわかっているから, 
<span class="math">\(x+29=97n\ (n\in\mathbb{Z})\)</span> と表すことができることがわかる.
よって, <span class="math">\(x=97n-29,\ k=10n-3\)</span> である. 実際に <span class="math">\(n=1\)</span> とすると, <span class="math">\(x=68\)</span> となり, これは
先に示した復号化におけるモジュラ逆数の演算例,
<span class="math">\(q\equiv \dfrac{1}{10}\equiv 68\pmod{97}\)</span>&nbsp;と整合であることがわかる.</p>
<p>ここで, いまやった一連の作業を一般化しておく. この計算が <span class="math">\((s+1)\)</span>&nbsp;回で終わったとする.
</p>
<div class="math">\begin{eqnarray}
&amp;r_1&amp;=&amp;a-bq_1\label{eq:nineth}\tag{9}\\\
&amp;r_2&amp;=&amp;b-r_1q_2\label{eq:tenth}\tag{10}\\\
&amp;r_3&amp;=&amp;r_1-r_2q_3\label{eq:eleventh}\tag{11}\\\
&amp;\cdots &amp; &amp; \cdots \\\
&amp;r_i&amp;=&amp;r_{i-2}-r_{i-1}q_i\label{eq:twelveth}\tag{i}\\\
&amp;\cdots &amp; &amp; \cdots \\\
&amp;r_{s-1}&amp;=&amp;r_{s-3}-r_{s-2}q_{s-1}\\\
&amp;d&amp;=&amp;r_{s-2}-r_{s-1}q_s
\end{eqnarray}</div>
<p>
よって \(r_i=x_ia+y_ib\) として \(x_s,\ y_s\) を求めればよいこととなる.
まず, \(r_i=a-bq_i\) から \(x_1=1,\ y_1=-q_1\) について, \(\eqref{eq:nineth}\)
を \(\eqref{eq:tenth}\) に代入し \[r_2=b-(a-bq_1)q_2=-aq_2+b(1+q_1q_2)\] とする.
ここで \(x_2=-q_2,\ y_2=1+q_1 q_2\) を初期条件とする.
一般に \(r_i\) が \(a,\ b\) で表せるとしたとき \(r_i=x_i a+y_i b\) と表せるから
\(x_i,\ y_i\)&nbsp;の漸化式を次のようにおくことができる.</p>
<div class="math">\begin{array}{lcl}
r_{i-2}&amp;=&amp;x_{i-2}a+y_{i-2}b \\\
r_{i-1}&amp;=&amp;x_{i-1}a+y_{i-1}b \\\
r_i&amp;=&amp;x_i a+y_i b
\end{array}</div>
<p>これらを \(\eqref{eq:twelveth}\) に代入すると,
\[x_i a+y_i b=x_{i-2}a+y_{i-2}b-(x_{i-1}a+y_{i-1}b)q_i\]
両辺の \(a,\ b\)&nbsp;の係数を比較すると,</p>
<div class="math">\begin{array}{lcl}
x_i&amp;=&amp;x_{i-2}-x_{i-1}q_i\ \left(i\geq 3\right) \\\
y_{i}&amp;=&amp;y_{i-2} - y_{i-1}q_i
\end{array}</div>
<p>よって, いまのように順に \(x_3,\ x_4,\ \cdots,\ y_3,\ y_4,\cdots\) と計算していけば
<span class="math">\(d\)</span> の表示式である <span class="math">\(d=xa+yb\)</span> の <span class="math">\(x\)</span> と <span class="math">\(y\)</span> が求まる.
<a href="#euclidean">ユークリッドの互除法</a>の最後では, 
必ず \(r_n-1=r_n+q_{n+1} + 0 = r_n\) となるから, これを停止条件とし,&nbsp;次のように実装できる.</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="kr">let</span> <span class="n">gcdExt</span> <span class="ow">::</span> <span class="kt">Integral</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="n">gcdExt</span> <span class="n">a</span> <span class="mi">0</span> <span class="ow">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span> <span class="n">gcdExt</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="kr">let</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span> <span class="n">a</span> <span class="p">`</span><span class="n">quotRem</span><span class="p">`</span> <span class="n">b</span><span class="p">;</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="ow">=</span> <span class="n">gcdExt</span> <span class="n">b</span> <span class="n">r</span> <span class="kr">in</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">t</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
<span class="kt">Prelude</span><span class="o">&gt;</span> <span class="n">gcdExt</span> <span class="mi">10</span> <span class="mi">97</span>
<span class="p">(</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>この実装と同時に,&nbsp;モジュラ逆数の計算関数を次のように実装できる.</p>
<div class="highlight"><pre><span></span><span class="kt">Prelude</span><span class="o">&gt;</span> <span class="kr">let</span> <span class="n">modInv</span> <span class="ow">::</span> <span class="kt">Integral</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="n">a</span><span class="p">;</span> <span class="n">modInv</span> <span class="n">a</span> <span class="n">m</span> <span class="ow">=</span> <span class="kr">case</span> <span class="n">gcdExt</span> <span class="n">a</span> <span class="n">m</span> <span class="kr">of</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="o">$</span> <span class="kr">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="kr">then</span> <span class="n">x</span> <span class="o">+</span> <span class="n">m</span> <span class="kr">else</span> <span class="n">x</span><span class="p">;</span> <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">Nothing</span>
<span class="kt">Prelude</span><span class="o">&gt;</span> <span class="n">modInv</span> <span class="mi">10</span> <span class="mi">97</span>
<span class="kt">Just</span> <span class="mi">68</span>
</pre></div>


<p>あとは上の手順に従って,&nbsp;次のように復号関数が実装できる.</p>
<div class="highlight"><pre><span></span><span class="nf">decode</span> <span class="ow">::</span> <span class="kt">Keys</span> <span class="ow">-&gt;</span> <span class="kt">Cryptogram</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">String</span>
<span class="nf">decode</span> <span class="kr">_</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="kt">[]</span>
<span class="nf">decode</span> <span class="kr">_</span> <span class="p">[</span><span class="kr">_</span><span class="p">]</span> <span class="ow">=</span> <span class="kt">Nothing</span>
<span class="nf">decode</span> <span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">x1</span><span class="kt">:</span><span class="n">x2</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">case</span> <span class="n">modExp</span> <span class="n">x1</span> <span class="n">a</span> <span class="n">p</span> <span class="p">`</span><span class="n">modInv</span><span class="p">`</span> <span class="n">p</span> <span class="kr">of</span>
     <span class="p">(</span><span class="kt">Just</span> <span class="n">q</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">:</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="kt">Just</span> <span class="p">(</span><span class="n">chr</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">modExp</span> <span class="p">(</span><span class="n">x2</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="mi">1</span> <span class="n">p</span><span class="p">)))</span> <span class="o">&lt;*&gt;</span> <span class="n">decode</span> <span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span> <span class="n">xs</span>
     <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="kt">Nothing</span>
</pre></div>


<h4>実行</h4>
<p>最後に, ここまでで作ったモジュールをロードして, 暗号化,&nbsp;復号化を実行してみる.</p>
<div class="highlight"><pre><span></span><span class="o">*</span><span class="kt">Main</span> <span class="kt">Lib</span><span class="o">&gt;</span> <span class="kt">:</span><span class="n">m</span> <span class="o">+</span><span class="kt">System</span><span class="o">.</span><span class="kt">Environment</span>
<span class="o">*</span><span class="kt">Main</span> <span class="kt">Lib</span> <span class="kt">System</span><span class="o">.</span><span class="kt">Environment</span><span class="o">&gt;</span> <span class="n">p</span> <span class="ow">&lt;-</span> <span class="n">genRndSafePrime</span> <span class="mi">16</span>
<span class="o">*</span><span class="kt">Main</span> <span class="kt">Lib</span> <span class="kt">System</span><span class="o">.</span><span class="kt">Environment</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">prikey</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">genKeys</span> <span class="n">p</span> <span class="o">$</span> <span class="n">rootFromSafePrime</span> <span class="n">p</span>
<span class="o">*</span><span class="kt">Main</span> <span class="kt">Lib</span> <span class="kt">System</span><span class="o">.</span><span class="kt">Environment</span><span class="o">&gt;</span> <span class="kr">let</span> <span class="n">f</span> <span class="ow">=</span> <span class="p">(</span><span class="o">=&lt;&lt;</span><span class="p">)</span> <span class="p">(</span><span class="n">print</span> <span class="o">.</span> <span class="n">decode</span> <span class="p">(</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">prikey</span><span class="p">))</span> <span class="o">.</span> <span class="n">encode</span> <span class="n">pubkey</span>
<span class="o">*</span><span class="kt">Main</span> <span class="kt">Lib</span> <span class="kt">System</span><span class="o">.</span><span class="kt">Environment</span><span class="o">&gt;</span> <span class="n">mapM_</span> <span class="n">f</span> <span class="p">[</span><span class="s">&quot;hoge&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;roki&quot;</span><span class="p">]</span>
<span class="kt">Just</span> <span class="s">&quot;hoge&quot;</span>
<span class="kt">Just</span> <span class="s">&quot;bar&quot;</span>
<span class="kt">Just</span> <span class="s">&quot;foo&quot;</span>
<span class="kt">Just</span> <span class="s">&quot;roki&quot;</span>
</pre></div>


<p>うまくいっているようだ. なお,&nbsp;すべての実装やテストコードは,</p>
<p style="text-align: center;">
<i class="fab fa-github" style="font-size: large; margin-right: 5px;"></i>
<a href="https://github.com/falgon/ElgamalEncryptionHs" name="impl">falgon/ElgamalEncryptionHs - The rustic implementation of ElGamal encryption encoder and its&nbsp;decoder.</a>
</p>

<p>にて公開している.</p>
<h3>参考文献</h3>
<ul>
<li><a href="https://mathforum.org/library/drmath/view/60779.html"><span class="dquo">&#8220;</span>Primitive Elements vs. Generators&#8221;</a> 2018 年 7 月 9&nbsp;日アクセス.</li>
<li>伊東利哉, 辻井 重男 (1989)「<a href="https://ipsj.ixsq.nii.ac.jp/ej/index.php?active_action=repository_view_main_item_detail&amp;page_id=13&amp;block_id=8&amp;item_id=32713">有限体における原始根の生成アルゴリズム</a>」 2018 年 7 月 9&nbsp;日アクセス.</li>
<li>von zur Gathen, Joachim; Shparlinski, Igor (1998), <a class="disabled" name="ref1">&#8220;Orders of Gauss periods in finite fields&#8221;</a>, Applicable Algebra in Engineering, Communication and&nbsp;Computing</li>
<li>Robbins, Neville (2006), <a class="disabled" name="ref2">Beginning Number Theory</a>, Jones <span class="amp">&amp;</span> Bartlett Learning, <span class="caps">ISBN</span>&nbsp;978-0-7637-3768-9. </li>
<li>「<a name="ref4" href="https://mathtrain.jp/galoisfield">有限体（ガロア体）の基本的な話</a>」 2018 年 6 月 29&nbsp;日アクセス.</li>
<li>「<a name="ref5" href="https://mathtrain.jp/phi">オイラーのファイ関数のイメージと性質</a>」 2018 年 7 月 9&nbsp;日アクセス.</li>
<li>Andreas V. Meier (2005), &#8220;<a href="https://wwwmayr.in.tum.de/konferenzen/Jass05/courses/1/papers/meier_paper.pdf">The ElGamal Cryptosystem</a>&#8221; 2018 年 7 月 9&nbsp;日アクセス.</li>
<li><span class="dquo">&#8220;</span><a name="ref6" href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf"><span class="caps">FIPS</span> <span class="caps">PUB</span> 186-4 Digital Signature Standard (<span class="caps">DSS</span>)&#8221;</a> 2018 年 7 月 9&nbsp;日アクセス.</li>
<li><span class="dquo">&#8220;</span><a name="ref7" href="https://crypto.stackexchange.com/a/79">How can I generate large prime numbers for <span class="caps">RSA</span>?</a>&#8221; 2018 年 7 月 9&nbsp;日アクセス.</li>
<li><span class="dquo">&#8220;</span><a name="ref8" href="https://en.wikipedia.org/w/index.php?title=Miller%E2%80%93Rabin_primality_test&oldid=832585246">Miller–Rabin primality test</a>&#8221; 2018 年 7 月 9&nbsp;日アクセス.</li>
<li>「<a name="ref9" href="https://lupus.is.kochi-u.ac.jp/shiota/misc/field/FiniteField.html">有限体― 塩田研一覚書帳 ―」</a>」2018 年 6 月 27&nbsp;日アクセス.</li>
<li><span class="dquo">&#8220;</span><a name="ref10" href="http://joye.site88.net/papers/JP06pgen.pdf">Fast Generation of Prime Numbers on Portable Devices: An Update</a>&#8221; 2018 年 7 月 13&nbsp;日アクセス.</li>
</ul>
<div class="footnote">
<hr>
<ol>
<li id="fn-1">
<p>既約多項式を使うと <span class="math">\(p\)</span> が素数でなくても(<span class="math">\(p\)</span> が位数の素数のべき乗であれば)構成できるが, 本エントリの主題と大きく逸れてしまうため, とくに触れない.&#160;<a class="footnote-backref" href="#fnref-1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn-2">
<p>言葉の<a href="#ref4">参照</a>.&#160;<a class="footnote-backref" href="#fnref-2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn-3">
<p>これに関しては, <a href="https://falgon.github.io/roki.log/posts/2018/%207月/09/arithmeticFunction/">数論的関数の用語と例</a>で説明している.&#160;<a class="footnote-backref" href="#fnref-3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn-4">
<p><a href="#ref5">参照</a>.&#160;<a class="footnote-backref" href="#fnref-4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn-5">
<p>エルガマル暗号では素数を扱うこととなるので, 本エントリでは, フェルマーの小定理の一般形であるオイラーの定理(<span class="math">\(a^{\phi(n)}\equiv 1\pmod{n}\ \left(\gcd(a, n) = 1, a,n \in \mathbb{Z}^{+}\right)\)</span>)に関しては特に触れていないが, 後に<a href="https://falgon.github.io/roki.log/posts/2018/%207月/25/EulersAndCarmichelsTheorem/">別のエントリ</a>として取り上げた.&#160;<a class="footnote-backref" href="#fnref-5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn-6">
<p>この「位数」という単語にはいくつか用例があるので注意. 「<i>群には、群の位数と、元の位数の２通りがあります。 群の位数は、体と同じく、要素の個数を表しますが、 元 <span class="math">\(x\)</span> の位数とは <span class="math">\(x^n=単位元 e\)</span> となる最小の自然数 <span class="math">\(n\)</span> のことです。 元 <span class="math">\(x\)</span> の位数が <span class="math">\(n\)</span> ならば、<span class="math">\(x\)</span> の生成する巡回部分群 <span class="math">\(&lt; x &gt; = { e, x, x2, ... }\)</span> の群位数も <span class="math">\(n\)</span> になることから同じ用語を使っているようです。</i>」<a href="#ref9">有限体― 塩田研一覚書帳 ―</a>&#160;<a class="footnote-backref" href="#fnref-6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn-7">
<p><a href="#thiscode">このコード</a>では, 先頭から 100 個の素数 <span class="math">\(p\)</span> を位数とした <span class="math">\(GF(p)\)</span> の原始元を求めているが, やはり大きな素数 <span class="math">\(p\)</span> に対しては, とくに時間がかかる. このような <span class="math">\(a\)</span> を法とする原始元を計算する単純な一般式は知られていない(参照1: <a href="#ref1">von zur Gathen <span class="amp">&amp;</span> Shparlinski 1998</a>, pp. 15–24: <i>&#8220;One of the most important unsolved problems in the theory of finite fields is designing a fast algorithm to construct primitive roots.&#8221;</i> 参照2: <a href="#ref2">Robbins 2006, p. 159</a>: <i>&#8220;There is no convenient formula for computing [the least primitive root].&#8221;</i>)が, より高速に見つけ出す方法として確率的アルゴリズムがいくつか知られている.&#160;<a class="footnote-backref" href="#fnref-7" title="Jump back to footnote 7 in the text">&#8617;</a><a class="footnote-backref" href="#fnref2-7" title="Jump back to footnote 7 in the text">&#8617;</a><a class="footnote-backref" href="#fnref3-7" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn-8">
<p>図は python, matplotlib 等で<a href="https://gist.github.com/falgon/97dc3c1a399422a3ab2818d01b70a14b">生成</a>.&#160;<a class="footnote-backref" href="#fnref-8" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn-9">
<p>しかしながら, <a href="https://falgon.github.io/roki.log/posts/2018/%206月/08/qft/">量子フーリエ変換を用いた探索</a>は, この離散対数問題に対しても有効的な解決手段である.&#160;<a class="footnote-backref" href="#fnref-9" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn-10">
<p><a href="#ref7"><span class="dquo">&#8220;</span>How can I generate large prime numbers for <span class="caps">RSA</span>?&#8221;</a>, <i>&#8220;The standard way to generate big prime numbers is to take a preselected random number of the desired length, apply a Fermat test (best with the base 2 as it can be optimized for speed) and then to apply a certain number of Miller-Rabin tests (depending on the length and the allowed error rate like <span class="math">\(2^{−100}\)</span>) to get a number which is very probably a prime number.&#8221;</i>&#160;<a class="footnote-backref" href="#fnref-10" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn-11">
<p>この「対偶」は, 全称命題への対偶であることに留意.&#160;<a class="footnote-backref" href="#fnref-11" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
<li id="fn-12">
<p>素朴な実装であることに注意. arithmoi パッケージの<code>isFermatPP</code>を使うことも考えたが(これを使うと <span class="math">\(20\)</span> 秒ほどで <span class="math">\(200\)</span> 個の偽素数が得られた), 計算量を度外視すれば, これは単純に実装できるので書いてしまった. ベキ乗剰余の計算は, 取り敢えず繰り返し二乗法にした.&#160;<a class="footnote-backref" href="#fnref-12" title="Jump back to footnote 12 in the text">&#8617;</a></p>
</li>
<li id="fn-13">
<p><a href="#ref8">Miller–Rabin primality test</a>, (snip) <i>then n is not prime. We call a a witness for the compositeness of n (sometimes misleadingly called a strong witness, although it is a certain proof of this fact). Otherwise a is called a strong liar, and n is a strong probable prime to base a.</i> (snip) <i>Note that Miller-Rabin pseudoprimes are called strong pseudoprimes.</i>&#160;<a class="footnote-backref" href="#fnref-13" title="Jump back to footnote 13 in the text">&#8617;</a></p>
</li>
<li id="fn-14">
<p><a href="#ref8">Miller-Rabin primality test</a>, (snip) <i>Every odd composite n has many witnesses a, however, no simple way of generating such an a is known. </i>&#160;<a class="footnote-backref" href="#fnref-14" title="Jump back to footnote 14 in the text">&#8617;</a></p>
</li>
<li id="fn-15">
<p><a href="#ref8">Miller-Rabin primality test</a>, (snip) <i>When the number n to be tested is small, trying all \(a \lt 2\left(\ln n\right)^2\) is not necessary, as much smaller sets of potential witnesses are known to suffice</i>&#160;<a class="footnote-backref" href="#fnref-15" title="Jump back to footnote 15 in the text">&#8617;</a></p>
</li>
<li id="fn-16">
<p>この値は, <a href="#ref6"><span class="caps">FIPS</span> <span class="caps">PUB</span> 186-4 <span class="caps">DSS</span></a>/<span class="caps">APPENDIX</span>/C.3 の &#8220;Minimum number of Miller-Rabin iterations for <span class="caps">DSA</span>&#8221; を参照. このテーブルに関する裏付けの参考として<a href="https://stackoverflow.com/a/6330138/8345717">この回答</a>を参照.&#160;<a class="footnote-backref" href="#fnref-16" title="Jump back to footnote 16 in the text">&#8617;</a></p>
</li>
<li id="fn-17">
<p>Haskell のライブラリ, Math.NumberTheory.Primes.Testing の<code>millerRabinV</code>は, 内部で libgmp を呼び出しているようだ.&#160;<a class="footnote-backref" href="#fnref-17" title="Jump back to footnote 17 in the text">&#8617;</a></p>
</li>
<li id="fn-18">
<p>より一般的には, \(d\) 準安全素数というものもあり, その場合素数 <span class="math">\(p\)</span> に対して \(\left(p-1\right)\div 2^d\) が素数となる.&#160;<a class="footnote-backref" href="#fnref-18" title="Jump back to footnote 18 in the text">&#8617;</a></p>
</li>
<li id="fn-19">
<p>この場合, <span class="math">\(2p\)</span> は準素数といえる.&#160;<a class="footnote-backref" href="#fnref-19" title="Jump back to footnote 19 in the text">&#8617;</a></p>
</li>
<li id="fn-20">
<p>この方法よりも効率の良い方法として, <a href="#ref10">参考文献</a>の &#8220;4.2 Generating safe and quasi-safe primes&#8221; に言及がある. また, 既知の部分群の生成元を探す方法もある. <span class="caps">DSA</span> はこの方法を採用しているとのこと: <a href="#ref6">4 The Digital Signature Algorithm (<span class="caps">DSA</span>)</a>&#160;<a class="footnote-backref" href="#fnref-20" title="Jump back to footnote 20 in the text">&#8617;</a></p>
</li>
</ol>
</div>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (true) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js','color.js','enclose.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: false," +
        "    messageStyle: 'None'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
      </div>
<!-- /.entry-content -->
      <footer class="post-info text-muted">
        <button type="button" class="btn btn-default">          
          <a href="../../../../../category/math.html"><div class="fa fa-lg fa-folder-open"></div> math</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="../../../../../tag/math.html"><div class="fa fa-lg fa-tag"></div> math</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="../../../../../tag/elementary-number-theory.html"><div class="fa fa-lg fa-tag"></div> Elementary number theory</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="../../../../../tag/group-theory.html"><div class="fa fa-lg fa-tag"></div> Group theory</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="../../../../../tag/haskell.html"><div class="fa fa-lg fa-tag"></div> Haskell</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="../../../../../tag/python.html"><div class="fa fa-lg fa-tag"></div> Python</a>
        </button>
      </footer>
      <!-- /.post-info -->
    <!-- Comment BEGIN -->
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'roki-log';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <!-- Comment END -->
    </section>
    </div>
<footer class="footer">
      <div class="container">
          <p class="footer-text">&copy; <a href="../../../../..">roki.log</a> powered by 
          <a href="https://getpelican.com/">pelican</a> and 
          <a href="https://github.com/falgon/nikhil-theme">nikhil-theme (forked)</a><br>
              <small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.ja"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.ja">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>, except where indicated otherwise.
</small>
            </p>
   </div>
</footer>    <script src="../../../../../theme/js/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-116653080-1', 'auto');
      ga('send', 'pageview');
       $('#myModal').modal({show: true});

    </script>
  </body>
</html>